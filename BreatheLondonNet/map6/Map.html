<!DOCTYPE html>
    <html>
        <head>
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <link rel="stylesheet" href="./css/jquery-ui.min.css">
            <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
            <link rel="shortcut icon" href="#">
            <link rel="stylesheet" href="Map.css?v=1">
        </head>
        <body>
            <!-- Left hand panel containing map key and options -->   
            <div id="layerPanel" class="sideControls">
                <a href="javascript:void(0)" id="closeLHSonPhone" style="right: 40px;position: absolute;z-index: 999;" onclick="hideShowPanelsAndMapButtons('');"><img id="arrowL1" border="0" alt="" src="./icons/Cross.png" width="30" height="30"></a>  
                <a href="javascript:void(0)" id="closeLHSTab" class="tabLeft"  onclick="closeLHS()"><img id="arrowL" border="0" alt="" src="./icons/CloseL2.png" width="30" height="30"></a>
                <div id="headingLayers" style="overflow: hidden;width:100%;">
                    <h2  id="nowhourtitle" class="panelTitle" style="color: #f00379; font-size: 20px;" >Air quality</h2>
                    <div id="averageDiv" style="width:200px; margin-right: auto; margin-top: 12px; margin-bottom: 4px;">
                        <div  id="averageOptions" class="LHSSection">
                            <input type="radio" class="regular-radio" name="AQRadios" id="current" value="current" onclick="showTimePeriod('current');" checked><label for="current"></label><label for="current" class="AQLabel">Current</label><br/>
                            <input type="radio" class="regular-radio" name="AQRadios" id="average" value="average" onclick="showTimePeriod('average');"><label for="average"></label><label for="average" class="AQLabel">Average</label><br/>
							<input type="radio" class="regular-radio" name="AQRadios" id="source" value="source" onclick="showTimePeriod('source');"><label for="source"></label><label for="source" class="AQLabel">Sources</label>
                        </div>
                    </div>
                </div>
                
                <div data-simplebar id="Layers" class="panelInfo" style="overflow: auto;height:85%; width:100%;">
                    <div id="layerDiv" style="width:200px">
                        <div  id="blMonitorTypes" class="LHSSection">
                            <button  class="legendAccordion active">Breathe London monitors</button>
                            <div class="panel">  
                                <table style="border-collapse:collapse">
                                    <tbody>
                                        <tr style="height: 25px;">
                                            <td class="tooltip" style="width:20px;height:20px;">
                                                <input type="checkbox" id="bloption" class="regular-checkbox" value="bloption" onclick="changeMonitorTypes(featureType.AQMESH);" checked><label for="bloption"></label>
                                            </td>
                                            <td class="tooltip" style="width:20px;height:20px;">
                                                <label for="bloption">
                                                <svg height="20" width="20">
                                                    <circle cx="10" cy="10" r="6" stroke="#F00379" stroke-width="1" fill="white"></circle>
                                                </svg>
                                                
                                                </label>
                                            </td>
                                            <td style="width:135px;font-size:11pt; padding-left: 5px; padding-top: 3px; vertical-align: top;">
                                                <label for="bloption"> Monitor sites</label>
                                                
                                            </td>
                                        </tr>
                                        <tr id="googlecars">
                                            <td class="tooltip" style="width:20px;height:20px;">
                                                <input type="checkbox" id="caroption" class="regular-checkbox" value="caroption" onclick="showRoads();"><label for="caroption" id="caroptionlabel" style="border-color:#dddddd; background-color:#dddddd;" ></label>



                                            </td>
                                            <td class="tooltip" style="width:20px;height:20px;">
                                                <div>
                                                    <label for="caroption"> 
                                                    <img id="carimage" style="padding-top:3px;" src="icons/Car2.png"/>

                                                        
                                                    </label> 
                                                </div>
                                            </td>
                                            <td style="width:135px;font-size:11pt; padding-left: 5px; padding-top: 3px;vertical-align: top;">
                                                <label for="caroption" id="caroptiontext" style="color: #dddddd;"> On-road (NO2 only)</label>
                                            </td>
                                        </tr>
                                   </tbody>
                                </table>  
                            </div>            
                        </div>
                        <div  id="otherMonitorTypes" class="LHSSection">
                            <button  class="legendAccordion active">Other monitors</button>
                            <div class="panel">  
                                <table style="border-collapse:collapse">
                                    <tbody>
                                        
                                        
                                        <tr id="othernetworks" style="height: 25px;">
                                            <td class="tooltip" style="width:20px;height:20px;">
                                                <input type="checkbox" id="otheroption" class="regular-checkbox" value="otheroption" onclick="changeMonitorTypes(featureType.LAQN);" checked><label for="otheroption"  id="otheroptionlabel"></label>
                                            </td>
                                            <td class="tooltip" style="width:20px;height:20px;">
                                                <div>
                                                    <label for="otheroption"> 
                                                    
                                                    
                                                        <svg height="20" width="20">
                                                            <path d="M 10,17 17,10 10,3 3,10 z" style="fill:white;stroke:#444;stroke-width:1" id="otheroptionimg"></path>
                                                        </svg>
                                                    </label> 
                                                </div>
                                            </td>
                                            <td style="width:135px;font-size:11pt; padding-left: 5px; padding-top: 3px;vertical-align: top;">
                                                <label for="otheroption" id="otheroptiontext"> Regulatory networks</label>
                                            </td>
                                        </tr>
										<tr id="otherschools" style="height: 25px;">
                                            <td class="tooltip" style="width:20px;height:20px;">
                                                <input type="checkbox" id="schooloption" class="regular-checkbox" value="schooloption" onclick="changeMonitorTypes(featureType.FIA);" checked><label for="schooloption"  id="schooloptionlabel"></label>
                                            </td>
                                            <td class="tooltip" style="width:20px;height:20px;">
                                                <div>
                                                    <label for="schooloption"> 
                                                    
                                                        <svg height="20" width="20">
                                                            <path d="M 10 4 L 16.9282 16 L 3.0718 16 Z" style="fill:white;stroke:#444;stroke-width:1" id="schooloptionimg"></path>
                                                        </svg>
                                                    </label> 
                                                </div>
                                            </td>
                                            <td style="width:135px;font-size:11pt; padding-left: 5px; padding-top: 3px;vertical-align: top;">
                                                <label for="schooloption" id="schooloptiontext"> School Streets sites</label>
                                            </td>
                                        </tr>
                                        
                                    </tbody>
                                </table>  
                            </div>            
                        </div>
                       

                        <div  id="pollutantCaptionWrapperDiv"  class="LHSSection">
                            <button class="legendAccordion active">Pollutant</button>
                            <div class="panel">  
                                <div id="pollutantRadioDiv" >
								
                                    <input type="radio" class="regular-radio" name="pollutantRadios" id="NO2" value="NO2" checked><label for="NO2" style="margin-left:2px;"></label><label id="NO2Label" for="NO2" class="pollutantLabel">NO2</label>
									<br/>
                                    <input type="radio" class="regular-radio" name="pollutantRadios" id="PM2_5" value="PM2_5"><label for="PM2_5" style="margin-left:2px;"></label><label id="PM2_5Label" for="PM2_5" class="pollutantLabel">PM2.5</label>
									<br/>
									<input type="radio" class="regular-radio" name="pollutantRadios" id="NOx" value="NOx" disabled><label for="NOx" style="margin-left:2px;"></label><label id="NOxLabel" for="NOx" class="pollutantLabel" >NOx</label>
                                    <br/>
                                </div>
                            </div>
                        </div>
                    
                        <div  id="ConcentrationSection" class="LHSSection">
                            <button class="legendAccordion active">Concentration (&mu;g/m&sup3;)</button>
                            <div class="panel">  
                            <div id="NO2table" >
                                <table style="border-collapse:collapse">
                                   <tbody>
                                      <tr id="trG7">
                                        <td id="colourG7TD" class="tooltip" style="width:20px;height:20px;border: 1px solid #550000; background-color: #550000;color:#FFFFFF; border-radius: 50%;">
                                        </td>
                                        <td style="width:150px;font-size:11pt; padding-left: 10px; padding-top: 3px;">
                                          <div> > 200</div>
                                        </td>
                                      </tr>
                                      <tr style="height:3px;"></tr>
                                      <tr id="trG6">
                                        <td id="colourG6TD" class="tooltip" style="width:20px;height:20px;border: 1px solid #A10000; background-color:#A10000;color:#FFFFFF;border-radius: 50%;">
                                        </td>
                                        <td style="width:150px;font-size:11pt; padding-left: 10px; padding-top: 3px;">
                                          <div> 100 - 200</div>
                                        </td>
                                      </tr>
                                      <tr style="height:3px;"></tr>
                                      <tr id="trG5">
                                        <td id="colourG5TD" class="tooltip" style="width:20px;height:20px;border: 1px solid #F40000; background-color:#F40000;color:#FFFFFF;border-radius: 50%;">
                                        </td>
                                        <td style="width:150px;font-size:11pt; padding-left: 10px; padding-top: 3px;">
                                          <div> 60 - 100</div>
                                        </td>
                                      </tr>
                                      <tr style="height:3px;"></tr>
                                      <tr id="trG4">
                                        <td id="colourG4TD" class="tooltip" style="width:20px;height:20px;border: 1px solid #FF6800; background-color:#FF6800;color:#FFFFFF;border-radius: 50%;">
                                        </td>
                                        <td style="width:150px;font-size:11pt; padding-left: 10px; padding-top: 3px;">
                                          <div> 40 - 60</div>
                                        </td>
                                      </tr>
                                      
                                      <tr style="height:3px;"></tr>
                                      <tr id="trG3">
                                        <td id="colourG3TD" class="tooltip" style="width:20px;height:20px;border: 1px solid #FFE200; background-color:#FFE200;color:#FFFFFF;border-radius: 50%;">
                                        </td>
                                        <td style="width:150px;font-size:11pt; padding-left: 10px; padding-top: 3px;">
                                          <div> 20 - 40</div>
                                        </td>
                                      </tr>
                                      <tr style="height:3px;"></tr>
                                      <tr id="trG2">
                                        <td id="colourG2TD" class="tooltip" style="width:20px;height:20px;border: 1px solid #FFFF9D; background-color:#FFFF9D;color:#FFFFFF;border-radius: 50%;">
                                        </td>
                                        <td style="width:150px;font-size:11pt; padding-left: 10px; padding-top: 3px;">
                                          <div> 10 - 20</div>
                                        </td>
                                      </tr>
                                      <tr style="height:3px;"></tr>
                                      <tr>
                                        <td id="colourBelowTD" class="tooltip" style="width:20px;height:20px;border: 1px solid #FFFFDB; background-color:#FFFFDB; color:#FFFFFF;border-radius: 50%;">
                                        </td>
                                        <td style="width:150px;font-size:11pt; padding-left: 10px; padding-top: 3px;">
                                          <div> 0 - 10</div>
                                        </td>
                                      </tr>
                                      <tr style="height:8px;">
                                      <td></td>
                                     <td><hr style="border-top: dotted 1px #BBBBBB; " /></td>
                                      </tr>
                                      </tbody>
                                </table>  
                            </div>
                            
                            
                            <div id="PM25table" style="display:none">
                                <table  style="border-collapse:collapse">
                                   <tbody>
                                      <tr id="trG7">
                                        <td id="colourG7TD" class="tooltip" style="width:20px;height:20px;border: 1px solid #550000; background-color: #550000;color:#FFFFFF; border-radius: 50%;">
                                        </td>
                                        <td style="width:150px;font-size:11pt; padding-left: 10px; padding-top: 3px;">
                                          <div> > 50</div>
                                        </td>
                                      </tr>
                                      <tr style="height:3px;"></tr>
                                      <tr id="trG6">
                                        <td id="colourG6TD" class="tooltip" style="width:20px;height:20px;border: 1px solid #F40000; background-color:#F40000;color:#FFFFFF;border-radius: 50%;">
                                        </td>
                                        <td style="width:150px;font-size:11pt; padding-left: 10px; padding-top: 3px;">
                                          <div> 25 - 50</div>
                                        </td>
                                      </tr>
                                      <tr style="height:3px;"></tr>
                                      <tr id="trG5">
                                        <td id="colourG5TD" class="tooltip" style="width:20px;height:20px;border: 1px solid #FF6800; background-color:#FF6800;color:#FFFFFF;border-radius: 50%;">
                                        </td>
                                        <td style="width:150px;font-size:11pt; padding-left: 10px; padding-top: 3px;">
                                          <div> 10 - 25</div>
                                        </td>
                                      </tr>
                                      
                                      <tr style="height:3px;"></tr>
                                      <tr id="trG4">
                                        <td id="colourG4TD" class="tooltip" style="width:20px;height:20px;border: 1px solid #FFE200; background-color:#FFE200;color:#FFFFFF;border-radius: 50%;">
                                        </td>
                                        <td style="width:150px;font-size:11pt; padding-left: 10px; padding-top: 3px;">
                                          <div> 5 - 10</div>
                                        </td>
                                      </tr>
                                      <tr style="height:3px;"></tr>
                                      <tr>
                                        <td id="colourBelowTD" class="tooltip" style="width:20px;height:20px;border: 1px solid #FFFFDB; background-color:#FFFFDB; color:#FFFFFF;border-radius: 50%;">
                                        </td>
                                        <td style="width:150px;font-size:11pt; padding-left: 10px; padding-top: 3px;">
                                          <div> 0 - 5</div>
                                        </td>
                                      </tr>
                                      <tr style="height:8px;">
                                      <td></td>
                                     <td><hr style="border-top: dotted 1px #BBBBBB; " /></td>
                                      </tr>
                                      
                                                            
                                   </tbody>
                                </table>  
                               </div>
                               <table  style="border-collapse:collapse">
                                   <tbody>
                                        <tr>
                                            <td class="tooltip" style="width:20px;height:20px;border: 1px solid #dadada; background-color: #dadada;color:#FFFFFF;border-radius: 50%;"></td>
                                            <td style="width:150px;font-size:11pt;padding-left: 10px;"><div id="noDataLocations"> No current data</div></td>
                                        </tr>
                                        <tr style="height:1px;"></tr>
                                        <tr id="pastlocations">
                                            <td class="tooltip" style="width:22px;height:22px;">
                                                <label>
                                                    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" height="22" width="22" xml:space="preserve">
                                                        <defs> 
                                                            <pattern id="lightstripe" patternUnits="userSpaceOnUse" width="5" height="5"> 
                                                                <image xlink:href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPSc1JyBoZWlnaHQ9JzUnPgogIDxyZWN0IHdpZHRoPSc1JyBoZWlnaHQ9JzUnIGZpbGw9J3doaXRlJy8+CiAgPHBhdGggZD0nTTAgNUw1IDBaTTYgNEw0IDZaTS0xIDFMMSAtMVonIHN0cm9rZT0nIzg4OCcgc3Ryb2tlLXdpZHRoPScxJy8+Cjwvc3ZnPg==" x="0" y="0" width="5" height="5"> </image> 
                                                            </pattern> 
                                                        </defs>
                                                        <circle cx="11" cy="11" r="11" stroke="#F00379" stroke-width="0" fill="url(#lightstripe)"></circle>
                                                    </svg>
                                                </label>
                                            </td>
                                            <td style="width:150px;font-size:11pt;padding-left: 10px;"><div> Past locations</div></td>
                                        </tr>                      
                                    </tbody>
                                </table>  
                                <br>                  
                            </div>
                        </div>

                        
                        <div class="LHSSection">
                            <button  class="legendAccordion active">Emission zones</button>
                            <div class="panel">
                                <table style="border-collapse:collapse; margin-bottom: 25px;">
                                  <tbody>
                                      <tr id="trG1"; height="40px";>
                                        <td class="tooltip" style="width:20px;height:20px;">
                                        <input type="checkbox" class="regular-checkbox" id="ulez" value="ulez" onclick="showEmissionZones('ULEZ');"><label for="ulez"></label>
                                        </td>
                                        <td id="colourG1TD" class="tooltip" style="width:20px;height:20px;border: 0px solid #807F7F; border-bottom:0px; background-color: #FFFFFF;color:#FFFFFF; padding-top:0; padding-bottom:0;">
                                        <label for="ulez"><hr style="border: 0px; border-bottom: 6px solid #145A32;"></label>
                                        </td>
                                        <td style="width:130px;font-size:11pt; padding-left: 5px; padding-top: 3px;vertical-align: top;">
                                          <label for="ulez" style="font-size:9pt;vertical-align: top;"> Ultra Low Emission Zone (ULEZ)</label>
                                        </td>
                                      </tr>
                                       <tr id="trG0" ; height="40px";>
                                        <td id="colourG1TD" class="tooltip" style="width:20px;height:20px;">
                                        <input type="checkbox" class="regular-checkbox" id="eulez" value="eulez" onclick="showEmissionZones('Expanded ULEZ');"><label for="eulez"></label>
                                        </td>
                                        <td id="colourG1TD" class="tooltip" style="width:20px;height:20px;border: 0px solid #807F7F; border-bottom:0px; background-color: #FFFFFF;color:#FFFFFF; padding-top:0; padding-bottom:0;"><label for="eulez"><hr style="border: 0px; border-bottom: 5px solid #27AE60;"></label>
                                        </td>
                                        <td style="width:130px;font-size:11pt; padding-left: 5px; padding-top: 3px;vertical-align: top;">
                                          <label for="eulez"  style="font-size:9pt;vertical-align: top;"> Expanded ULEZ</label>
                                        </td>
                                      </tr>
                                      <tr id="trG0" ; height="40px";>
                                        <td id="colourG1TD" class="tooltip" style="width:20px;height:20px;">
                                        <input type="checkbox" class="regular-checkbox" id="lez" value="lez" onclick="showEmissionZones('LEZ');"><label for="lez"></label>
                                        </td>
                                        <td id="colourG1TD" class="tooltip" style="width:20px;height:20px;border: 0px solid #807F7F; border-bottom:0px; background-color: #FFFFFF;color:#FFFFFF; padding-top:0; padding-bottom:0;"><label for="lez"><hr style="border: 0px; border-bottom: 4px solid #A9DFBF;"></label>
                                        </td>
                                        <td style="width:130px;font-size:11pt; padding-left: 5px; padding-top: 3px;vertical-align: top;">
                                          <label for="lez"  style="font-size:9pt;vertical-align: top;"> Low Emission Zone (LEZ)</label>
                                        </td>
                                      </tr>
                                   </tbody>
                                </table>  
                            </div>
                        </div> 
                    </div>
                </div>
            </div>
      
      
        <!--  Right hand side panel containing monitor data/graphs, information  -->
        <div id="sitePanel" class="sideControls" style="display:none;">  
            <!-- Button to hide/show the panel -->
            <a href="javascript:void(0)" id="closeRHS" onclick="deselectSite()" style="right: 20px;position: absolute;z-index: 999;"><img border="0" alt="" src="./icons/Cross.png" width="20" height="20"></a> 

            <div data-simplebar  id="sitePanelScroll" style="overflow: auto;width:100%;height:100%;">
                <!-- If a monitor is selected, show the data, and for active BreatheLondon monitors show a small graph -->
                <div id="SiteDiv" style="height: min(100%, 500px);width:280px;">
                    <!-- Fixed monitor information -->
                    
                    <table>
                            <tbody>
                                <tr>
                                    <td style="width:30px;color:#888888;">
                                        <div>
                                            <img  id="networkIcon" style="margin-top: 4px;" src="icons/Car.png"/>
                                        </div>
                                    </td>
                                    <td style="width:160px;">
                                        <p id="monitorNetwork"></p>
                                     </td>
                                </tr>
                            </tbody>
                    </table>
                    
                    <h2 id="monitorName" style="width:280px;" class="panelTitle"></h2>
                    <!-- Only for Breathe London pods -->
                    <h3 id="monitorBorough" style="margin: 0;"></h3>
                    <p id="monitorType" style="margin: 0;color: #bbbbbb;"></p>
                    <h3 id="monitorHistorical" style="margin:8px 0px 0px 0px;font-style: italic;">Past location</h3>
                    
                    <!-- Monitor data time(s) - The current time or the time range depending on the data selected -->
                    <h3 id="monitorTime" style="margin:12px 0px 0px 0px;"></h3>
                    <h3 id="monitorTime2" style="margin:0;"></h3>
                    
                    <!-- The monitor data -->
                    <div id="overView" style="width:260px; padding-bottom: 12px; ">
                        <h3 id="dataTitle" style="font-weight:bold;"></h3>
                        <!-- Table with the results -->
                        <table class="overviewTable">
                            <tbody>
                                <tr>
                                    <td id="pollName" style="width:60px;color:#888888;">NO2</td>
                                    <td id="pollValue" style="width:120px;"></td>
                                    <td id="pollDot" style="width:40px;"></td>
                                </tr>
                                <tr id="Passes">
                                    <td style="width:60px;color:#888888;"></td>
                                    <td id="pollPasses" style="width:120px;"></td>
                                </tr>
                           </tbody>
                        </table>
                        
                        <p id="overviewSubtitle">On-road data was collected by Google Street View cars that are specially equipped with mobile sensors.</p>
                        
                        <!-- Link for LAQN monitors -->
                        <p id="pastData" class="laqnonly">Past air quality data is available on <a target="_blank" href="https://www.londonair.org.uk/london/asp/publicdetails.asp">London Air</a></p>  
                        <!-- For old/moved monitors give the user a button to view the historical graph, as there won't be a current map -->
                        <div class="historyonly" id="graphHistoryButton" style="margin:24px 0px 12px 0px;"></div>
					</div>
						
					
                   
                    
                    <!-- Graph of the selected monitor's recent data -->
                    <div id="graphRHS" >
                         <div id="graphButton" style="width:65px; z-index: 1;background-color:white;float:left;padding-top:13px;display:none;"></div> 
                        <h2 class="sectionHeader" id="smallGraphTitle" style="font-size:16px;font-weight:600;" >Past 24 hours</h2> 
                        <h2 class="sectionHeader" id="graphPollutant" style="float:left;">NO2 <i>(&mu;g/m&sup3;)</i></h2> 
                        <div id="smallGraph" style="width:280px; height:200px;">
                            <div id="graphSmallDiv" class="graphDiv" style="width:280px; height:190px;"></div>
                        </div>
                        <br>
						<br>
                    </div>
                 
                    <!-- The FAQ button is obscured by this panel, so added the link to this panel too -->
                    <div id="subcategories">   	
						<img id="categoryIMG"  src="./images/car-pink.png" class="categoryIMG" alt="" style="    width: 24px; color: #f00379;">	
						<select name="categories" id="categories" class="icon-menu"   onchange="updateCategories(this.value, false);">
							<option id="roadCategory" class="categoryoption" value="0">Road Transport</option>
							<option id="otherTransCategory" class="categoryoption" value="1">Other Transport</option>
							<option id="constructCategory" class="categoryoption" value="2">Construction & Industrial</option>
							<option id="buildCategory" class="categoryoption" value="3">Buildings</option>
							<option id="otherCategory" class="categoryoption"  value="4">Other</option>
						</select> 
						<table id="sourcetb">
							<thead>
								<tr>
									<th id="sourcevalue" ></th>
								</tr>
							</thead>
							<tbody>
							</tbody>
						</table>
                        
                    </div>
					
                    <p id="AQDCLink" style="display: block;">Explore the data on the <a target="_blank" href="https://aqdatacommons.org/superset/dashboard/london_aqmesh/">Air Quality Data Commons</a></p> 
					
					<div id="airTEXT" style="border-top: 1px solid #bbb;">      
						<h3 id="dataTitle2a" style="font-weight:bold;"></h3>
                        <table class="overviewTable2" style="width:260px; padding-bottom: 12px;">
                            <tbody>
								<tr >
                                    <td style="width:50%;color:#888888;">Tomorrow</td>
                                    <td style="width:50%;color:#888888;">Day after</td>
                                </tr> 
                                <tr id="Alerts">
                                    <td id="forecastDay1" style="width:50%;color:#888888;background-color:#dadada;text-align: center;"/>
									<td id="forecastDay2" style="width:50%;color:	#ffcb00;background-color:#888888;text-align: center;"/>
                                </tr> 
                            </tbody>
                        </table>
						<p id="airTEXTLink" style="margin-top: 0px;">The forecast alerts are produced by  <a target="_blank" href="https://www.airtext.info/"><i>air</i><b>TEXT</b></a></p> 
					</div>
					
                    <!-- The FAQ button is obscured by this panel, so added the link to this panel too -->
                    <div id="faqlink" style="width:280px; padding-bottom: 12px; border-top: 1px solid #bbb;">
                        <a href="javascript:void(0)" id="openFAQ" onclick="ShowFAQFromLink();">Frequently Asked Questions</a>
                    </div>
                </div>
             </div>
          </div>
          
          
          <div id="faqPanel" class="sideControls" style="display:none;">
            <!-- Button to hide/show the panel -->
            <a href="javascript:void(0)" id="closeFAQ" style="right: 20px;position: absolute;z-index: 999;" onclick="closeFAQ();"><img border="0" alt="" src="./icons/Cross.png" width="20" height="20"></a> 

            <div data-simplebar style="overflow: auto;height:100%;width:100%;">
                <div id="faqDiv" style="width:300px; margin-bottom: 25px;height:100%;">
                    <!-- <h2 class="panelTitle">Breathe London</h2>
                    <p class="sectionText">Using the most comprehensive network of monitors of its kind, Breathe London maps pollution at the street level to paint a clearer picture of air quality across the city. Measuring harmful pollution at thousands of locations informs data-driven solutions to clean up our dirty air and foster healthier, stronger communities.</p>
                    -->
                    <h2 class="sectionHeader" style="margin-top:25px;">Pollutants</h2>
                    <button class="faqAccordion">What is NO2?</button>
                    <div class="panel">  
                        <p class="sectionText">Nitrogen dioxide (NO<sub>2</sub>) is produced when fossil fuels such as coal, oil, gas or diesel are burned at high temperatures. Transportation, power plants, commercial and domestic gas boilers and industrial equipment are major sources. Short term exposure to NO2 irritates our lungs and aggravates respiratory diseases like asthma, leading to symptoms (such as coughing, wheezing or difficulty breathing), hospital admissions and visits to A&amp;E. Chronic exposure to NO2 is associated with decreased lung growth in children, development of new cases of asthma and heart disease, as well as higher risk of premature mortality.</p>
                    </div>
                    <button class="faqAccordion">What is PM2.5?</button>
                    <div class="panel">      
                        <p class="sectionText">Particulate matter (PM) is made up of small airborne particles like dust, soot, and drops of liquids. Most particulate matter (PM) in urban areas is formed from fossil fuels used in power plants, vehicles, construction equipment, and industrial facilities. PM2.5 (fine particulate matter, or particles with a diameter smaller than 2.5 microns) is linked to lung disease, heart attacks, strokes, asthma, cancer and eventually premature death. New evidence suggests it also leads to impaired brain development in children.</p>
                    </div>
                    <h2 class="sectionHeader">FAQs</h2>
                    <button class="faqAccordion">Why are there different monitor types?</button>
                    <div class="panel">  
                        <p class="sectionText">The map shows current and average readings from Breathe London&#39;s stationary monitors, as well as averages from mobile sensors on specially-equipped Google Street View cars. The map also displays other networks of stationary monitors (&#34;Other monitors&#34;). These include the School Streets network, deployed to measure the benefits of School Streets and other interventions, and networks of regulatory monitors like London Air Quality Network and Air Quality England. </p><p class="sectionText">Breathe London&#39;s sensor pods are not regulatory grade monitors, but can complement them and add another, more localized, layer of air pollution information. To learn more about the monitor types, visit our <a target="_blank" href="https://www.breathelondon.org/faq/">FAQ page</a>.</p>
                    </div>
                    <button class="faqAccordion">Why do some pods have &#34;no current data&#34;?</button>
                    <div class="panel">  
                        <p class="sectionText">We are currently unable to see data from some of these pods due to a temporary delay. In these cases, we are working to resolve the underlying issue and restore data collection and transmission as soon as possible. Please note the data from some of the pods is still undergoing quality assurance and control; these will be live on the map soon.</p>
                    </div>
                    <button class="faqAccordion">Why are some pods &#34;past locations&#34;?</button>
                    <div class="panel">  
                        <p class="sectionText">These pods are no longer in place, likely because the location was found to be unsuitable. Clicking on the pod will display the average reading for the dates it was active. .</p>
                    </div>
                    <button class="faqAccordion">What do the different colours mean?</button>
                    <div class="panel">  
                        <p class="sectionText">The different colours inside the circles and diamonds representing monitor locations indicate the average pollutant concentration measured at that site, if data is available. The colour scale used is based on a heat-palette with the colours getting darker, or warmer, as the pollution levels increase.</p>
                    </div>
                    <button class="faqAccordion">What are the health guidelines for the pollutants&#39; concentration?</button>
                    <div class="panel">  
                        <p class="sectionText">Data from Breathe London monitors are indicative only and cannot be used to determine health impacts, but the rise and fall of pollution and changes in pollution on different days; at different times of day; and between different locations can be seen and compared.  Data from the regulatory network can be used to determine health impacts, but the live data provided here is still provisional. For NO2, the World Health Organisation (WHO) limits for short-term exposure indicate levels exceeding 200 &mu;g/m&sup3; (hourly average) can cause acute health effects. The long-term or annual average guideline is at 40 &mu;g/m&sup3;. UK legal limits are in line with WHO guidelines for NO2.</p><p class="sectionText">For PM2.5, WHO short-term limits are 25 &mu;g/m&sup3; (24-hour average), and long-term or annual average guideline is 10 &mu;g/m&sup3; annual mean. Current UK legal limits are not in line with WHO guidelines for PM2.5; UK annual limits are 25 &mu;g/m&sup3;.</p>
                    </div>

                    <button class="faqAccordion">What are emission zones?</button>
                    <div class="panel">  
                        <p class="sectionText">The <a href="https://tfl.gov.uk/modes/driving/ultra-low-emission-zone" target="_blank">Ultra Low Emission Zone</a> (ULEZ) was introduced in April 2019 and charges drivers of more polluting vehicles to enter central London. It operates 24 hours a day, every day of the year, in addition to the Congestion Charge (NOT 24/7).</p><p class="sectionText">The <a href="https://tfl.gov.uk/modes/driving/low-emission-zone" target="_blank">Low Emission Zone</a> (LEZ) charges older heavy vehicles in most of Greater London and, from October 2020, the tighter ULEZ standards will apply across this area for buses, coaches and lorries. For lighter vehicles, the ULEZ is due to expand to cover an area that reaches to the North and South Circulars from October 2021.</p>
                    </div>
                    <button class="faqAccordion">What is the monitor category?</button>
                    <div class="panel">  
                        <p class="sectionText">Most monitoring sites are categorised as kerbside, roadside or urban background. Kerbside sampling sites are within 1m of the kerb of a busy road. Roadside sites are within 1 &mdash; 5m of a busy road and ideally located at breathing height. Background sites should be at least 50m away from any large pollution sources, such as construction sites, petrol stations, multi-storey car parks and airports. These categories help to explain why levels of pollution can vary so much from pod to pod, even in a small area.</p>
                    </div>
					<button class="faqAccordion">What does an air quality alert mean?</button>
					<div class="panel">  
                        <p class="sectionText">The Breathe London map incorporates air quality alerts that show forecasts of expected pollution levels for tomorrow and the day after. The forecasts are taken from the free <a href="https://www.airtext.info/signup" target="_blank">airTEXT service</a>. Air quality alerts are designed to help ensure you can plan ahead and, if possible, reduce your exposure.  If you suffer from a medical condition, like asthma, which can be made worse by air pollution, these alerts provide some notice so that you may have any necessary medication at hand. The alerts use Defra's <a href="https://uk-air.defra.gov.uk/air-pollution/daqi" target="_blank">Daily Air Quality Index (DAQI)</a>, which tells you about levels of air pollution and provides recommended actions and health advice.</p>
                    </div>
					<button class="faqAccordion">What are pollution sources and how are they determined?</button>
					<div class="panel">  
                        <p class="sectionText">The Breathe London map shows the contribution of different sources of nitrogen oxides (NOx) pollution at monitoring sites across the city in 2019. <a href="https://www.breathelondon.org/pollution-sources/" target="_blank">London&apos;s pollution sources</a> include emissions from transport such as diesel vehicles and lorries, and from the way we heat and power our homes and businesses. We estimated the influence of these sources at each location <a href="https://www.breathelondon.org/methodology/" target="_blank">using the ADMS model</a> to account for factors such as the influence of weather and the distance from the sources to the locations.</p>
                    </div>
                </div>
            </div>
         </div>

         <!-- Dialog for explanations (guidelines, pollutants etc) -->
         <div id="ExplanatoryDialogDiv"> </div>
         
         <!-- The map div that will contain the Google map and all associated controls -->
         <div id="map" ></div>
         
         <!--
            CUSTOM MAP CONTROLS
         -->
         
         <!-- The layers div is not open by default on phones (small screens), so the page title is shown alone on the map -->
         <div id="phoneHeadingLayers" style="width:200px;">
             <h2  id="nowhourtitle2" class="panelTitle" style="text-shadow: 0 0 7px #ffffff;">Current air quality</h2>
         </div>
         
         <!-- The Search box control, which is added to the map as a control -->
         <div id="searchMapControls"   style="display: block;padding:5px;">
            <div id="searchBox" style="display: block;">
                <!-- Search button -->
                <input id="searchLocationButton" type="image" src="./icons/Search.png" alt="Search" style="float:right;border-style:solid;border-width:1px;border-color: gray;" onclick="showSearchControls()"></input>
                <div class="autocomplete" id="searchControls" style="max-width:270px;background-color: white;float:left;display:none;border-style:solid;border-width:1px;border-color: gray;"> 
                    <!-- Search box -->
                    <input id="searchInputTextBox" style="max-width:270px;height:28px;border-style:none;font-size:11pt;margin:0px 0px 0px 5px" type="text" name="search" placeholder="Search.." autocomplete="off"> 
                    <!-- Search results -->
                    <ul id="result" style="margin:0px 0px 0px 5px;font-size:11pt;"></ul>
                </div> 
                <!-- Text if selected place is outside bounds -->
                <div id="searchLocationWarning" style="max-width:270px; float:left;border-style:solid;border-width:1px;border-color: gray; color: #000023; background-color: #ffffca; font-weight: bold; padding: 7px;">
                </div> 
            </div>
         </div>
        
         <!-- The current location control, which is added to the map as a control -->
         <div id="currentLocationMapControls"   style="display: block;padding:5px;">
            <div style="display: block;">
                <!-- Current location button -->
                <input id="currentLocationButton" type="image" src="./icons/YouAreHereWhite.png" alt="You are here" style="float:right;border-style:solid;border-width:1px;border-color: gray;" onclick="showCurrentLocation();" onfocusout="clearLocationWarnings();"></input>
                <!-- Text containing any warnings (Outside bounds, no Geolocation) -->
                <div id="currentLocationWarning" style="max-width:270px; float:left;border-style:solid;border-width:1px;border-color: gray; color: #000023; background-color: #ffffca; font-weight: bold; padding: 7px;">
                </div> 
            </div>
         </div>
 
         <!-- Map control to show who made the map, when the latest data is from and proportion of current monitors -->
         <div id="measuredAtDiv">
            <p id="measuredAt">Map by CERC   Measured at </p>
         </div> 

        <!-- Pod Dialog Control for graphs and table -->
        <div id="podDialogDiv">
          <div id = "podDialogTabs">
            <div id="graphSensorNameTRContainer">
              <div style="vertical-align: middle; height: 32px;"><span id="graphSensorNameTR">Sensor name.&nbsp;</span><img src="./icons/Cross.png" alt="Close window" onclick="closePodDialog(true)" onmouseover="this.src='./icons/Cross.png';" onmouseout="this.src='./icons/Cross.png';"></div>

            </div> 
            <div id="graphTabContents">
              <div id="graphHeader">
                <p id="graphSensorName">Sensor name.&nbsp;</p>
                <p id="graphPollutantTitle">Particulate Matter (PM2.5)</p>
              </div>
              <!-- Graph Control -->
              <div id="graphLargeDiv" class="graphDiv" ></div>
              <div id="graphFooter">
                <p id="disclaimerWHO">The graph shows daily average concentrations of PM2.5 in London. Also displayed are the World Health Organization's Air Quality Guidelines for PM2.5; evidence-based targets for air quality management to protect populations from the adverse health effects of air pollution.</p>          
              </div>
              <div id="graphControlHeader">
                <p id="graphControlHeaderP">Select Data</p>
              </div>
              <div id="graphControls">
                <div id="dateFromContainer">
                  <label for="dateFrom">Date From:</label>
                  <input type="text" id="dateFrom" readonly="true">
                </div>
                <p class="graphControlsBreaker"></p>
                <div id="dateToContainer">
                  <label for="dateTo">Date To:</label>
                  <input type="text" id="dateTo" readonly="true">
                </div>
                <p class="graphControlsBreaker"></p>
                <div id="graphPollSelectContainer">
                  <div id="graphPollSelectLabelAndImage" >
                    <label for="graphPollSelect">Pollutant:</label>
                    <img class="graphPollutantInfo" src="./icons/Info_icon-72a7cf.svg" onclick="showGraphPollutantDialog();" > 
                  </div>
                  <select id="graphPollSelect"></select>              
                </div>
                <p class="graphControlsBreaker"></p>
                <div id="graphButtonContainer">
                  <img id="Refresh" src="./icons/RefreshGrey.png" alt="Update" title="Update graph" onclick="drawClicked();" onmouseover="this.src='./icons/RefreshHoverGrey.png';" onmouseout="this.src='./icons/RefreshGrey.png';" style="margin:0px 10px" >
                </div>
              </div>
            </div>
        </div>
      </div>

    <script>
		var el;
        var mapPollutantCodeNames; // code names of the pollutants on the map
		var map;
		var aqmeshData;
		var sites = [];
		var pollDataset;
		var layout2;
		var roadY1 = 0;
		var roadY2 = 0;

		var sectionSizerEventsLoaded = false;
		var popupShown =false;
		
		var sourceDialogShown = false;
		var currentBar = 0;
		var numPods;
		var numBLMonitors;
		var numOtherMonitors;
		var activeFeature;
		var currentMapPollCodeName = "NO2";
		var service;
		var BreatheLondonPinkColour = '#f00379';
		//Colours of the station if there are no valid values
		var NoColour = "#ffffff";
		//Colours of the borders of the station symbols
		var NoLevelBorderColour = "#999999";
		var selectedMarker = "";
		var ezLayer;
		var carLayer = null;
		var currentZoom = 11;
		var previousWidth;
		var mapLoaded = false;
		var currentSelectedSiteID;
		var sessionToken;
		var selectedRoad = null;
		var selectedRoad2;
		var selectedRoadBorder = null;
		var showCars = false;
		var showOther = true;
		var showSchool = true;
		var dataMode = "current";
		var bRoadLoaded = false;
		var selectedFeature = null;
		var searchButtonDiv = null;
		var currentLocationButtonDiv = null;

		var bargraphcolours = [BreatheLondonPinkColour, "#dadada", "#dadada", "#dadada", "#dadada"];
		var markercolours = [NoColour, "#FEFE31", "#F0A400", "#F50017"];
		var newmarkercolours = ["#FFFFDB", "#FFFF9D", "#FFE200", "#FF6800", "#F40000", "#A10000", "#550000"];
		var longTermColour = markercolours[2];
		var shortTermColour = markercolours[3];
		var markeropacity = 1;
		var opac = 0.7;

		var mapBoundsMinLat = 51.25;
		var mapBoundsMaxLat = 51.75;
		//var mapBoundsMaxLat=52.25;  //Including Cambridge for testing
		var mapBoundsMinLon = -0.616;
		var mapBoundsMaxLon = 0.32;
		var mapBounds;
		
		var initialMode = "current";
		var loadedMode = false;
		var pageLoaded = false;

		var COUNT_OF_GOOGLE_ROADS = 17743; // HACK hard-coded maximum number of roads

		var currentInfoWindow = null;
		//Laqn and AQMesh use different shape markers.  Circle are standard Google markers, square defined in SVG
		var circle_shape; //gets its value once Google Maps loaded
		var diamond_shape = 'M 0,1.5 1.5,0 0,-1.5 -1.5,0 z';
		var triangle_shape = 'M-1.5 0.8666 L0 -1.7333 L1.5 0.8666 z';
		
		var categoryGraphBlankStackDown; 
		var categoryGraphBlankStackUp; 

		var currentLocationSelected = false;
		var currentLocationPopup;

		var searchLocationPopup;
		var searchPlaceShown = false;

		var carSpinner = null;
		
		const featureType = {
			AQMESH: 'aqmesh',
			LAQN: 'laqn',
			AQE: 'aqe',
			FIA: 'fia',
			GOOGLE: 'google'
		};
		
		var selectedSiteType = "";
		var nearestSite;
		
		var graphAQMeshDataURL;

		var getParams = function(url) {
			var params = {};
			var parser = document.createElement('a');
			parser.href = url;
			var query = parser.search.substring(1);
			var vars = query.split('&');
			for (var i = 0; i < vars.length; i++) {
				var pair = vars[i].split('=');
				params[pair[0]] = decodeURIComponent(pair[1]);
			}
			return params;
		};

		var subcategoryLookup = {
			"SewageTreatment": "Sewage Treatment",
			"Other": "Residual",
			"NonLondon": "Outside London",
			"TaxisOtherCarsMotorcycles": "Taxis, Other Cars and Motorcycles",
			"DieselCars": "Diesel Cars",
			"LGVs": "Vans",
			"Buses": "Buses and Coaches",
			"HGVs": "Lorries",
			"Aviation": "Aviation",
			"CommercialShipping": "River",
			"Rail": "Rail",
			"Construction": "Non-Road Mobile Machinery Construction",
			"NRMMIndustrial": "Non-Road Mobile Machinery Industrial",
			"IndustrialProcesses": "Industrial Processes",
			"Domestic": "Domestic Heat and Power",
			"Commercial": "Commercial Heat and Power",
		};

		var categoryLookup = {
			0: {
				displayName: "Road Transport",
				codeName: "RoadTransport",
				imgSelected: './images/car-pink.png',
				imgUnselected: './images/car-grey.png'
			},
			1: {
				displayName: "Other Transport",
				codeName: "OtherTransport",
				imgSelected: './images/train-pink.png',
				imgUnselected: './images/train-grey.png'
			},
			2: {
				displayName: "Construction & Industrial",
				codeName: "ConstructionAndIndustry",
				imgSelected: './images/snowplow-pink.png',
				imgUnselected: './images/snowplow-grey.png'
			},
			3: {
				displayName: "Buildings",
				codeName: "Buildings",
				imgSelected: './images/home-pink.png',
				imgUnselected: './images/home-grey.png'
			},
			4: {
				displayName: "Other",
				codeName: "Other",
				imgSelected: './images/smog-pink.png',
				imgUnselected: './images/smog-grey.png'
			},

		};

		var iconImages2 = [{
				"source": categoryLookup[0].imgSelected,
				"xref": "x",
				"yref": "y",
				"x": 0,
				"y": 5,
				"sizex": 1,
				"sizey": 15,
				"xanchor": "center",
				"yanchor": "bottom"
			},
			{
				"source": categoryLookup[1].imgUnselected,
				"xref": "x",
				"yref": "y",
				"x": 1,
				"y": 5,
				"sizex": 1,
				"sizey": 15,
				"xanchor": "center",
				"yanchor": "bottom"
			},
			{
				"source": categoryLookup[2].imgUnselected,
				"xref": "x",
				"yref": "y",
				"x": 2,
				"y": 5,
				"sizex": 1,
				"sizey": 15,
				"xanchor": "center",
				"yanchor": "bottom"
			},
			{
				"source": categoryLookup[3].imgUnselected,
				"xref": "x",
				"yref": "y",
				"x": 3,
				"y": 5,
				"sizex": 1,
				"sizey": 15,
				"opacity": 1,
				"xanchor": "center",
				"yanchor": "bottom"
			},
			{
				"source": categoryLookup[4].imgUnselected,
				"xref": "x",
				"yref": "y",
				"x": 4,
				"y": 5,
				"sizex": 1,
				"sizey": 15,
				"opacity": 1,
				"xanchor": "center",
				"yanchor": "bottom"
			},
		];

		//Draws a selected or deselected site/road
		function drawSite(site, type, selected) {
			var strokeWidth;
			
			if (selected) {
				strokeWidth = 2;
			} else {
				strokeWidth = 1;
			}
			
			switch (type) {
				case featureType.AQMESH:
					if (dataMode == "source") {
						strokeWidth = strokeWidth * 2;
					}
					var isAverage = document.getElementById("average").checked;
					if ((site.feature.properties.LocationEndDate !== undefined) && (dataMode == "current")) {
						//Historical only AQMesh site is shown using an svg with striped shading with a pink border
						//The "circle" in the svg has strokewidth of 2 for selected, and 1 for unselected
						var svgFile;
						if (selected) {
							svgFile = './icons/SelectedHistoricalMonitor.svg';
						} else {
							svgFile = './icons/HistoricalMonitor.svg';
						}
						site.marker.setIcon({
							anchor: new google.maps.Point(11, 11),
							url: svgFile
						});

					} else {
						//Other AQMesh sites are just a basic circle, coloured by the level, with a pink border
						site.marker.setIcon({
							path: circle_shape,
							fillOpacity: 1,
							scale: 10,
							strokeWeight: strokeWidth,
							strokeColor: BreatheLondonPinkColour,
							fillColor: site.marker.getIcon().fillColor
						});
					}
					break;
				case featureType.FIA:
					var strokecolour = NoLevelBorderColour;
					if (dataMode == "source") 
					{
						strokecolour = "black";
					} 
					site.marker.setIcon({
						path: triangle_shape,
						fillOpacity: 1,
						scale: 8,
						strokeWeight: strokeWidth,
						strokeColor: strokecolour,
						fillColor: site.marker.getIcon().fillColor
					});
					break;
				case featureType.AQE:
				case featureType.LAQN:
					//LAQN sites are just a basic diamond shape, coloured by the level with a grey border
					var strokecolour = NoLevelBorderColour;
					if (dataMode == "source") 
					{
						strokecolour = "black";
					} 
					site.marker.setIcon({
						path: diamond_shape,
						fillOpacity: 1,
						scale: 8,
						strokeWeight: strokeWidth,
						strokeColor: strokecolour,
						fillColor: site.marker.getIcon().fillColor
					});
					break;
				case featureType.GOOGLE:
					//Google road sections are simple polylines (no border) coloured by the level.
					//The widths depend on the map scale and whether it is selected or not
					if (map.getZoom() >= 15) {
						if (selected) {
							strokeWidth = 12;
						} else {
							strokeWidth = 4;
						}
						carLayer.overrideStyle(site.feature, {
							strokeWeight: strokeWidth
						});
					} else {
						if (selected) {
							strokeWidth = 6;
						} else {
							strokeWidth = 1;
						}
						carLayer.overrideStyle(site.feature, {
							strokeWeight: strokeWidth
						});
					}
					break;
			}
		}

		//When the user changes the LHS settings, reselectSite reloads the RHS with the updated data
		function reselectSite() {
			if (selectedFeature !== null) {
				//Deselect if the site doesn't have the pollutant
				if ((typeof selectedFeature.feature.properties[currentMapPollCodeName] == 'undefined') && (currentMapPollCodeName !== "NOx")) {
					deselectSite();
				} else if ((currentMapPollCodeName == "NOx") && (!selectedFeature.feature.properties.NOX)) {
					deselectSite();
				} else if ((currentMapPollCodeName == "NOx") && (!selectedFeature.feature.properties.NOX.Sources)) {
					deselectSite();
				} else {
					selectSite(selectedFeature, selectedSiteType, false);
				}
			}
		}

		//Called to select a site, from clicking on it or searching
		//Removes any existing selection, sets the display and shows the RHS
		function selectSite(site, type, panTo) {
			//deselect any previous selection, Set the selectedFeature, highlight and open the right hand side
			//Called by clicking on a feature or clicking on a search result
			deselectSite();
			selectedFeature = site;
			selectedSiteType = type;
			//highlight
			drawSite(site, type, true);
			map.controls[google.maps.ControlPosition.RIGHT_TOP].clear();
			
			var labelcolour;
			var labelText;
			var latLng;
			var borderColour;
			var fillColour;
			var pollutantValue = "";
			var pollutantPasses = "";
			var networkName = "";
			var networkIcon = "";
			var averageTitle = "";
			var overViewSubtitle = "";
			var monitorName = "";
			var monitorBorough = "";
			var monitorType = "";
			var monitorHistorical = "";
			var graphText = "";
			var graphButton = "";
			var smallGraphTitleText = "";
			var pollutantObject = getPollutantObject(currentMapPollCodeName);
			var dataValue;
			//Get data about site

			switch (type) {
				case featureType.AQMESH:
					isAQMesh = true;
					networkName = "Breathe London";
					labelcolour = BreatheLondonPinkColour;
					latLng = new google.maps.LatLng(site.feature.geometry.coordinates[1], site.feature.geometry.coordinates[0]);
					labelText = site.feature.properties.Name;

					networkIcon = "icons/BLMonitor.png";
					monitorName = site.feature.properties.Name;
					monitorBorough = "<b>" + site.feature.properties.Borough + "</b>";
					monitorType = site.feature.properties.SiteType;
					if (site.feature.properties.LocationEndDate !== undefined) {
						monitorHistorical = "Past location";
					} else {
						$("#dataTitle2a").text("Air quality alerts for " + site.feature.properties.airTEXTZone);
						setForecast(site.feature.properties.airTEXTForecasts, 1, "#forecastDay1");
						setForecast(site.feature.properties.airTEXTForecasts, 2, "#forecastDay2");
					}
					var NumValidHours;
					if (currentMapPollCodeName === "NO2") {
						NumValidHours = site.feature.properties.NO2.NumValidHoursSoFar;
					} else if (currentMapPollCodeName == "NOx") {
						NumValidHours = 0;
					} else {
						NumValidHours = site.feature.properties.PM2_5.NumValidHoursSoFar;
					}
					if (NumValidHours === -999) {
						monitorHistorical = "Undergoing quality assurance and control";
					}
					var noairTEXTZone = !(site.feature.properties.airTEXTZone);
					if ((site.feature.properties.LocationEndDate !== undefined) || (NumValidHours === -999)) {
						enableDisableRHSControls("BL", true, !noairTEXTZone);
					} else {
						enableDisableRHSControls("BL", false, !noairTEXTZone);
					}

					if (document.getElementById("average").checked) {
						overViewSubtitle = "Average air quality since start date.";
						averageTitle = "Average (mean) air quality";
						var siteAverage = averageForSite(pollutantObject, site);
						if (siteAverage === -999) {
							pollutantValue = "<b>no value</b> (hourly)";
							fillColour = "#dadada";
							borderColour = "#dadada";
						} else {
							pollutantValue = "<b><font size='4'>" + siteAverage.toFixed(1) + "</font></b> " + pollutantObject.unitsHtml;

							if (currentMapPollCodeName == "NOx") {
								fillColour = "white";
							} else {
								fillColour = colourFromValue(siteAverage);
							}
							borderColour = "#888888";
						}
					
					} else {
						overViewSubtitle = "Current air quality (1-hour average)";
						averageTitle = "Current air quality";

						dataValue = validatedValueForSite(pollutantObject, site);
						borderColour = "#888888";
						fillColour = colourFromValue(Number(dataValue));
						var isAverage = document.getElementById("average").checked;
						if ((site.feature.properties.LocationEndDate !== undefined) && (dataMode == "current")) {
							pollutantValue = "<b>no value</b> (hourly)";
							fillColour = "#dadada";
							borderColour = "#dadada";
						} else if ((NumValidHours === -999) && (dataMode != "source")) {
							pollutantValue = "<i>no current value</i>";
						} else if (dataValue === -999) {
							pollutantValue = "<b>no value</b> (hourly)";
						} else if (pollutantObject.hasGuidelines === false) {
							pollutantValue = "<b>no value</b> (hourly)";
						} else {
							pollutantValue = "<b> <font size='4'>" + Number(dataValue).toFixed(1) + "</font></b> " + pollutantObject.unitsHtml + " (hourly)";
						}
					}

					//Only need to show the graphs if they are 


					if ((typeof site.feature.properties[pollutantObject.codeName] !== 'undefined') || (pollutantObject.codeName == "NOx")) {

						if ((NumValidHours !== -999) || (pollutantObject.codeName == "NOx")) {
							document.getElementById('roadCategory').innerHTML = "Road Transport   [" + getCategoryPercentage("RoadTransport").toFixed(0) + "%]";
							document.getElementById('otherTransCategory').innerHTML = "Other Transport   [" + getCategoryPercentage("OtherTransport").toFixed(0) + "%]";
							document.getElementById('constructCategory').innerHTML = "Construction & Industrial   [" + getCategoryPercentage("ConstructionAndIndustry").toFixed(0) + "%]";
							document.getElementById('buildCategory').innerHTML = "Buildings   [" + getCategoryPercentage("Buildings").toFixed(0) + "%]";
							document.getElementById('otherCategory').innerHTML = "Other   [" + getCategoryPercentage("Other").toFixed(0) + "%]";
							if (pollutantObject.codeName == "NOx") {
								smallGraphTitleText = "Sources";
								graphText = "NOx pollution sources";
							} else {
								smallGraphTitleText = "Past 24 hours";
								graphText = pollutantObject.shortName + " <i>(" + pollutantObject.unitsHtml + ")</i>";
							}
							if (site.feature.properties.LocationEndDate !== undefined) {
								graphButton = "<a href='javascript:void(0)' onclick='showData(\"" + site.feature.properties.UniqueID + "\",true, \"" + site.feature.properties.LocationEndDate + "\")'>View past data</a>";
							} else {
								graphButton = "<a href='javascript:void(0)' onclick='showData(\"" + site.feature.properties.UniqueID + "\",false, undefined)'>&lt; Earlier</a>";
							}
							graphSite = site;
							var defaultDateTo = new Date();
							doPlot(currentMapPollCodeName, defaultDateTo, defaultDateTo, "graphSmallDiv", true);
						}
					}
					if (dataMode === "source") {
						document.getElementById('AQDCLink').style.display = "none";
					} else {
						document.getElementById('AQDCLink').style.display = "block";
					}
					
					break;
				case featureType.AQE:
				case featureType.LAQN:
				case featureType.FIA:
					isAQMesh = false;
					if (type === featureType.AQE) {
						networkName = "Air Quality England";
						siteName = site.feature.properties.Name;
						init = siteName.indexOf('(');
						fin = siteName.indexOf(')');
						siteid = site.feature.properties.Name.match(/\(([^)]+)\)/)[1];
						document.getElementById('pastData').innerHTML = "Past air quality data is available on <a target='_blank' href='https://www.airqualityengland.co.uk/site/data?site_id=" + siteid + "'>Air Quality England</a>";
						networkIcon = "icons/OtherMonitor.png";
						enableDisableRHSControls("Other", false, !!site.feature.properties.airTEXTZone);
					} else if (type === featureType.FIA) {
						networkName = "Schools Streets";
						document.getElementById('pastData').innerHTML = "Many London schools are introducing School Streets to create safe spaces for social distancing. The FIA Foundation, Bloomberg Philanthropies and the Greater London Authority are providing these air quality monitors to measure the benefits of School Streets and other interventions during September - December 2020. <br>The ratified data will be shown here once it is available.";
						networkIcon = "icons/SchoolMonitor.png";
						enableDisableRHSControls("School", false, !!site.feature.properties.airTEXTZone);
					} else {
						networkName = "London Air Quality Network";
						document.getElementById('pastData').innerHTML = "Past air quality data is available on <a target='_blank' href='https://www.londonair.org.uk/london/asp/publicdetails.asp'>London Air</a>";
						networkIcon = "icons/OtherMonitor.png";
						enableDisableRHSControls("Other", false, !!site.feature.properties.airTEXTZone);
					}
					smallGraphTitleText = "Sources";
					graphText = "NOx pollution sources";
					$("#dataTitle2a").text("Air quality alerts for " + site.feature.properties.airTEXTZone);
					setForecast(site.feature.properties.airTEXTForecasts, 1, "#forecastDay1");
					setForecast(site.feature.properties.airTEXTForecasts, 2, "#forecastDay2");
					monitorBorough = "<b>" + site.feature.properties.Borough + "</b>";
					monitorType = site.feature.properties.SiteType;
					labelcolour = NoLevelBorderColour;
					latLng = new google.maps.LatLng(site.feature.geometry.coordinates[1], site.feature.geometry.coordinates[0]);
					labelText = site.feature.properties.Name;
					
					monitorName = site.feature.properties.Name;
					if (document.getElementById("average").checked) {
						overViewSubtitle = "Average air quality since start date.";
						averageTitle = "Average (mean) air quality";
					} else {
						overViewSubtitle = "Current air quality (1-hour average)";
						averageTitle = "Current air quality";
					}
					dataValue = validatedValueForSite(pollutantObject, site);
					borderColour = "#888888";
					fillColour = colourFromValue(Number(dataValue));
					if (dataValue === -999) {
						pollutantValue = "<b>no value</b> (hourly)";
					} else if (pollutantObject.hasGuidelines === false) {
						pollutantValue = "<b>no value</b> (hourly)";
					} else {
						pollutantValue = "<b> <font size='4'>" + Number(dataValue).toFixed(1) + "</font></b> " + pollutantObject.unitsHtml + " (hourly)";
					}

					var defaultDateTo2 = new Date();
					if (dataMode === "source") {
					document.getElementById('roadCategory').innerHTML = "Road Transport   [" + getCategoryPercentage("RoadTransport").toFixed(0) + "%]";
					document.getElementById('otherTransCategory').innerHTML = "Other Transport   [" + getCategoryPercentage("OtherTransport").toFixed(0) + "%]";
					document.getElementById('constructCategory').innerHTML = "Construction & Industrial   [" + getCategoryPercentage("ConstructionAndIndustry").toFixed(0) + "%]";
					document.getElementById('buildCategory').innerHTML = "Buildings   [" + getCategoryPercentage("Buildings").toFixed(0) + "%]";
					document.getElementById('otherCategory').innerHTML = "Other   [" + getCategoryPercentage("Other").toFixed(0) + "%]";

					graphText = "NOx pollution sources";
					
						doPlot(currentMapPollCodeName, defaultDateTo2, defaultDateTo2, "graphSmallDiv", false);
					}


					document.getElementById('AQDCLink').style.display = "none";
					break;
				case featureType.GOOGLE:
					labelcolour = BreatheLondonPinkColour;
					latLng = site.latLng;
					labelText = site.feature.getProperty('name1');
					enableDisableRHSControls("road", false, false);
					if (currentMapPollCodeName === "NO2") {
						POLL_MEDIAN = site.feature.getProperty('no2_med');
						POLL_COUNT = site.feature.getProperty('no2_count');
						fillColour = colourFromNO2Value(POLL_MEDIAN);
					} else {
						POLL_MEDIAN = site.feature.getProperty('pm_2_5_med');
						POLL_COUNT = site.feature.getProperty('pm2_5_count');
						fillColour = colourFromPM25Value(POLL_MEDIAN);
					}

					borderColour = "#888888";
					pollutantValue = "<b><font size='4'>" + parseFloat(POLL_MEDIAN).toFixed(1) + "</font></b> " + pollutantObject.unitsHtml;
					overViewSubtitle = "On-road data was collected by Google Street View cars that are specially equipped with mobile sensors.";
					networkName = "On-road data";
					monitorName = labelText;
					averageTitle = "Average (median) air quality";
					networkIcon = "icons/Car.png";
					pollutantPasses = "[" + POLL_COUNT + " drives]";
					document.getElementById('AQDCLink').style.display = "none";
					smallGraphTitleText="";
					break;

			}

			//show Label
			if (labelText !== "") {
				popup = new Popup(latLng, labelText, labelcolour, site);
				popup.setMap(map);
				currentInfoWindow = popup;
			}
			//Show on right hand side
			document.getElementById('networkIcon').src = networkIcon;
			document.getElementById('monitorNetwork').innerHTML = networkName;

			document.getElementById('monitorName').innerHTML = monitorName;
			document.getElementById('monitorBorough').innerHTML = monitorBorough;

			if (monitorType) {
				document.getElementById('monitorType').innerHTML = monitorType.toUpperCase();
			} else {
				document.getElementById('monitorType').innerHTML = "";
			}
			document.getElementById('monitorHistorical').innerHTML = monitorHistorical;
			
setDisplayDates(site, NumValidHours, pollutantObject.codeName);
			document.getElementById('dataTitle').innerHTML = averageTitle;
			document.getElementById('pollName').innerHTML = pollutantObject.shortName;
			document.getElementById('pollValue').innerHTML = pollutantValue;
			document.getElementById('pollDot').innerHTML = "<span class='dot' style='background-color: " + fillColour + "; border: 1px solid " + borderColour + ";'></span>";

			document.getElementById('pollPasses').innerHTML = pollutantPasses;
			document.getElementById('overviewSubtitle').innerHTML = overViewSubtitle;

			document.getElementById('graphHistoryButton').innerHTML = graphButton;
			document.getElementById('graphButton').innerHTML = graphButton;
			document.getElementById('graphPollutant').innerHTML = graphText;
			document.getElementById('smallGraphTitle').innerHTML = smallGraphTitleText;

			document.getElementById("SiteDiv").style.display = "block";


			if (panTo) {
				map.setZoom(16);
				map.panTo(latLng);
			}
			
			document.getElementById("sitePanel").style.display = "block";
			recalculateScrollbar();

		}



		function recalculateScrollbar() {
			//If the RHS site panel is showing, then set the divs so the scrollbars will work
			if ($('#sitePanel').css('display') == 'block') {
				//$('#SiteDiv').redraw;
				var RHSHeight = $("#openFAQ").position().top + 30;
				if (RHSHeight > $("#map").height()) {
					//If the FAQ div (+ 30 pixels to get the text and a margin) wouldn't fit in the same height as the map div, then we'll need a scrollbar
					//The SiteDiv is the height of the information to be shown
					$("#SiteDiv").height(RHSHeight)	;
					//The sitePanel is the visible height
					$("#sitePanel").height($("#map").height())	;	
				}	else {
					$("#SiteDiv").height(RHSHeight)	;
					$("#sitePanel").height(RHSHeight)	;	
				} 
			}
		}
		

		function deselectSite() {
			//Set the selectedFeature to be null and close the right hand side and any highlighting
			//Called by selecting a new feature, clicking on the map (with no feature), closing the right hand side, change current/average, uncheck monitor type
			if (nearestSite !== null && nearestSite !== undefined) {
				nearestSite.setMap(null);
			}
			//dehighlight
			drawSite(selectedFeature, selectedSiteType, false);
			//REmove Label
			if (currentInfoWindow !== null) {
				currentInfoWindow.setMap(null);
			}
			selectedSiteType = "";
			selectedFeature = null;

			//close RHS 
			document.getElementById("sitePanel").style.display = "none";
			var phoneShow;
			if (useSmallScreen()) {
				phoneShow = "block";
			} else {
				phoneShow = "none";
			}
			map.controls[google.maps.ControlPosition.RIGHT_TOP].clear();
			ShowSearchButton(map, google.maps.ControlPosition.RIGHT_TOP);
			ShowCurrentLocationButtons(map, google.maps.ControlPosition.RIGHT_TOP);
			AddLayerButtons(map, google.maps.ControlPosition.RIGHT_TOP, phoneShow);
			AddFAQButtons(map, google.maps.ControlPosition.RIGHT_TOP);
		}



		function isTouchDevice() {
			return (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent));
		}

		function isIPad() {
			var userAgent = window.navigator.userAgent;
			return (userAgent.match(/iPad/i));
		}

		function useSmallScreen() {
			if ($(window).width() <= 700) {
				return true;
			} else {
				return false;
			}
		}



		//If the user clicks the back button (or forwards button) on the browser, close the pod dialog (if it is open)
		window.addEventListener('popstate', function() {
			closePodDialog(false);
		});

		//Show the user's current location
		function showCurrentLocation() {
			clearLocationWarnings();
			if (currentLocationSelected) {
				//deselectSite();
				//Deselect the current location
				if (currentLocationPopup !== null && currentLocationPopup !== undefined) {
					currentLocationPopup.setMap(null);
				}
				//Set the unselected button icon
				document.getElementById("currentLocationButton").src = './icons/YouAreHereWhite.png';
				currentLocationSelected = false;
			} else {
				//Check to see if the browser is allowing current location
				if (navigator.geolocation) {
					//Get the current location
					navigator.geolocation.getCurrentPosition(function(position) {
						//Check to see if the current location is within the map bounds
						if ((position.coords.latitude >= mapBoundsMinLat) && (position.coords.latitude <= mapBoundsMaxLat) && (position.coords.longitude >= mapBoundsMinLon) && (position.coords.longitude <= mapBoundsMaxLon)) {
							//Add current location to the map
							//Set the selected button icon
							document.getElementById("currentLocationButton").src = './icons/YouAreHerePink.png';
							//User's current location for finding the nearest pod
							var pos = {
								lat: position.coords.latitude,
								lng: position.coords.longitude
							};
							//Calculate the nearest pod
							find_closest_pod(pos);
							//Add a label to the map showing the user's location
							currentLocationPopup = new Popup(new google.maps.LatLng(position.coords.latitude, position.coords.longitude), "You are here", 'white', "");
							currentLocationPopup.setMap(map);
							currentLocationSelected = true;
						} else {
							//Warn the user that their location is outside of the map bounds
							document.getElementById('currentLocationWarning').style.display = 'block';
							document.getElementById('currentLocationWarning').style.maxWidth = ($(window).width() - 100).toString() + "px";
							document.getElementById("currentLocationWarning").innerHTML = "Unable to show your current location.<br>Your current location is outside the project extents.";
						}
					}, geoErrorHandler);
				} else {
					//Unable to determine the current location.
					document.getElementById('currentLocationWarning').style.display = 'block';
					document.getElementById('currentLocationWarning').style.maxWidth = ($(window).width() - 100).toString() + "px";
					document.getElementById("currentLocationWarning").innerHTML = "Unable to determine your current location.<br>Please check your browser settings.";
				}
			}
		}

		//Error handler if Geolocation is not available (this happens if the iFrame doesn't have geolocation enabled)
		function geoErrorHandler(err) {
			document.getElementById('currentLocationWarning').style.display = 'block';
			document.getElementById('currentLocationWarning').style.maxWidth = ($(window).width() - 100).toString() + "px";
			if (err.code == 1) {
				document.getElementById("currentLocationWarning").innerHTML = "Unable to determine your current location.<br>Please check your browser settings.";
			} else if (err.code == 2) {
				document.getElementById("currentLocationWarning").innerHTML = "Unable to determine your current location.<br>Please check your browser settings.";
			}
		}


		function showSearchControls() {
			if (searchPlaceShown) {
				searchPlaceShown = false;
				if (searchLocationPopup !== null && searchLocationPopup !== undefined) {
					searchLocationPopup.setMap(null);
				}
				document.getElementById("searchLocationButton").src = './icons/Search.png';
			} else {
				if (document.getElementById('searchControls').style.display === 'block') {
					document.getElementById('searchControls').style.display = 'none';
				} else {
					document.getElementById('searchControls').style.display = 'block';
					document.getElementById("searchInputTextBox").focus();
				}
			}
			clearLocationWarnings();
		}

		function loadPage(){
			if (document.readyState !== 'loading') {
				initialisePage();
			} else {
				document.addEventListener('DOMContentLoaded', function () {
					initialisePage();
				});
			}
		}
		
		window.addEventListener('load', function() {
			pageLoaded=true;
			initialPopup(initialMode);
		});
		
		function initialisePage() {
			initMap();
			sectionSizer();
			$(window).resize(function() {
				recalculateScrollbar();
				if (pageLoaded) {
					if (popupShown) {
						$("#ExplanatoryDialogDiv").dialog('close');
						$("#ExplanatoryDialogDiv").dialog('destroy');
						popupShown= false;
					}
				}
				
				if (($(document.activeElement).prop('type') !== 'text') && (document.getElementById('searchControls').style.display !== 'block')){
				closePodDialog(true);
				sectionSizer();
				var newWidth = $(window).width();
				if (typeof(previousWidth) != "undefined") {
					resizeControls();
					sectionSizer();
				} else {
					if ((newWidth > 700) && (previousWidth <= 700)) {
						resizeControls();
					}
					if ((newWidth <= 700) && (previousWidth > 700)) {
						resizeControls();
					}
				}
				previousWidth = newWidth;
				}
				
				

				
			});
		}
		
		function initMap() {
			circle_shape = google.maps.SymbolPath.CIRCLE;
			//Defines the grey map style 
			var styledMapType = new google.maps.StyledMapType(
				[{
						"elementType": "geometry",
						"stylers": [{
							"color": "#f5f5f5"
						}]
					},
					{
						"elementType": "labels.icon",
						"stylers": [{
							"visibility": "off"
						}]
					},
					{
						"elementType": "labels.text.fill",
						"stylers": [{
							"color": "#cccccc"
						}]
					},
					{
						"elementType": "labels.text.stroke",
						"stylers": [{
							"color": "#f5f5f5"
						}]
					},
					{
						"featureType": "administrative.land_parcel",
						"elementType": "labels.text.fill",
						"stylers": [{
							"color": "#bdbdbd"
						}]
					},
					{
						"featureType": "poi",
						"elementType": "geometry",
						"stylers": [{
							"color": "#eeeeee"
						}]
					},
					{
						"featureType": "poi",
						"elementType": "labels.text.fill",
						"stylers": [{
							"color": "#959595"
						}]
					},
					{
						"featureType": "poi.park",
						"elementType": "geometry",
						"stylers": [{
							"color": "#e5e5e5"
						}]
					},
					{
						"featureType": "poi.park",
						"elementType": "labels.text.fill",
						"stylers": [{
							"color": "#9e9e9e"
						}]
					},
					{
						"featureType": "road",
						"elementType": "geometry",
						"stylers": [{
							"color": "#ffffff"
						}]
					},
					{
						"featureType": "road.arterial",
						"elementType": "labels.text.fill",
						"stylers": [{
							"color": "#b5b5b5"
						}]
					},
					{
						"featureType": "road.highway",
						"elementType": "geometry",
						"stylers": [{
							"color": "#dadada"
						}]
					},
					{
						"featureType": "road.highway",
						"elementType": "labels.text.fill",
						"stylers": [{
							"color": "#919191"
						}]
					},
					{
						"featureType": "road.local",
						"elementType": "labels.text.fill",
						"stylers": [{
							"color": "#cecece"
						}]
					},
					{
						"featureType": "transit.line",
						"elementType": "geometry",
						"stylers": [{
							"color": "#e5e5e5"
						}]
					},
					{
						"featureType": "transit.station",
						"elementType": "geometry",
						"stylers": [{
							"color": "#eeeeee"
						}]
					},
					{
						"featureType": "water",
						"elementType": "geometry",
						"stylers": [{
							"color": "#8ec3ff"
						}]
					},
					{
						"featureType": "water",
						"elementType": "labels.text.fill",
						"stylers": [{
							"color": "#9e9e9e"
						}]
					}
				], {
					name: 'Grey Map'
				});

			var useragent = navigator.userAgent;
			//var gestureLevel = 'greedy';
			var gestureLevel = 'cooperative';
			if (isTouchDevice()) {
				gestureLevel = 'cooperative';
			}
			//Set the map's initial view, set to use the styled map above, remove the map type control and streetview control and let the map take the mouse/gestures
			var mapOptions = {
				zoom: 11,
				minZoom: 6,
				center: new google.maps.LatLng(51.521, -0.12),
				gestureHandling: gestureLevel,
				streetViewControl: false,
				mapTypeControl: false,
				mapTypeControlOptions: {
					mapTypeIds: ['styled_map'],
				},
				zoomControl: false,
				fullscreenControl: false
			};

			map = new google.maps.Map(document.getElementById('map'), mapOptions);

			// Create the DIV to hold the control and call the ZoomControl() constructor
			// passing in this DIV.
			var zoomControlDiv = document.createElement('div');
			zoomControlDiv.setAttribute("id", "zoomButtonRow");
			var zoomControl = new ZoomControl(zoomControlDiv, map);

			Popup = createPopupClass();


			var isIE11 = !!window.MSInputMethodContext && !!document.documentMode;
			if (!isIPad() && !isIE11) {
				AddFullScreenButtons(map, google.maps.ControlPosition.BOTTOM_CENTER);
			}
			zoomControlDiv.index = 1;
			map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push(zoomControlDiv);


			var phoneShow;
			var desktopShow;
			if (useSmallScreen()) {
				phoneShow = "block";
				desktopShow = "none";
			} else {
				phoneShow = "none";
				desktopShow = "block";
			}
			ShowSearchButton(map, google.maps.ControlPosition.RIGHT_TOP);
			ShowCurrentLocationButtons(map, google.maps.ControlPosition.RIGHT_TOP);
			AddLayerButtons(map, google.maps.ControlPosition.RIGHT_TOP, phoneShow);
			AddFAQButtons(map, google.maps.ControlPosition.RIGHT_TOP);
			map.mapTypes.set('styled_map', styledMapType);
			map.setMapTypeId('styled_map');

			//Clicking on the map closes any infowindows and deselects any selected features
			google.maps.event.addListener(map, 'click', function() {
				deselectSite();
			});

			ezLayer = new google.maps.Data();
			ezLayer.loadGeoJson('https://breathelondon.net/map/data/EmissionZonesUnsimplified.geojson');

			ezLayer.setStyle(function(feature) {
				var SD_NAME = feature.getProperty('Name');
				var color = "gray";
				if (SD_NAME == "ULEZ") {
					color = "#145A32";
				} else if (SD_NAME == "LEZ") {
					color = "#A9DFBF";
				} else {
					color = "#27AE60";
				}
				return {
					strokeColor: color,
					strokeWeight: 2
				};
			});

			ezLayer.setMap(null);

			//LAQN layer
			var theURL;
			theURL = "https://breathelondon.net/map/data/latestLAQNandAQE5.json";
			numOtherMonitors = 0;
			$.getJSON(theURL + "?v=" + Date.now(), function(data) {
				$.each(data.features, function(key, val) {
					var site = {
						feature: val,
						marker: "",
						infoWindow: ""
					};
					createMarker(site);
					sites.push(site);
					numOtherMonitors += 1;
				});
				//Sorting so the BreatheLondon Monitors appear above the LAQN monitors in the autocomplete
				sites.sort(function(a, b) {
					var x = a.feature.properties.Network.toLowerCase();
					var y = b.feature.properties.Network.toLowerCase();
					if (x < y) {
						return -1;
					}
					if (x > y) {
						return 1;
					}
					return 0;
				});
				updateMapAndLegend(currentMapPollCodeName);
			});

			//AQMesh layer
			theURL = "https://breathelondon.net/map/data/latestAQMesh12.json";
			numBLMonitors = 0;
			$.getJSON(theURL + "?v=" + Date.now(), function(data) {
				aqmeshData = data;

				$.each(data.features, function(key, val) {
					var site = {
						feature: val,
						marker: "",
						infoWindow: ""
					};
					createMarker(site);
					sites.push(site);
					numBLMonitors = numBLMonitors + 1;
				});
				sites.sort(function(a, b) {
					var x = a.feature.properties.Network.toLowerCase();
					var y = b.feature.properties.Network.toLowerCase();
					if (x < y) {
						return -1;
					}
					if (x > y) {
						return 1;
					}
					return 0;
				});
				updateMapAndLegend(currentMapPollCodeName);
			});

			//AQMesh layer
			theURL = "https://breathelondon.net/map/data/HistoricalAQMesh6.json";
			$.getJSON(theURL + "?ver=" + Date.now(), function(data) {
				$.each(data.features, function(key, val) {
					var site = {
						feature: val,
						marker: "",
						infoWindow: ""
					};
					createMarker(site);
					sites.push(site);
				});
				sites.sort(function(a, b) {
					var x = a.feature.properties.Network.toLowerCase();
					var y = b.feature.properties.Network.toLowerCase();
					if (x < y) {
						return -1;
					}
					if (x > y) {
						return 1;
					}
					return 0;
				});
				updateMapAndLegend(currentMapPollCodeName);
			});

			//Get the URL from the paths xml
			$.getJSON("https://breathelondon.net/map/data/paths.json", function(obj) {
				graphAQMeshDataURL=obj.DataAPIURL;
			});
			
			document.getElementById('graphButton').style.display = "none";

			map.controls[google.maps.ControlPosition.TOP_CENTER].push(document.getElementById('phoneHeadingLayers'));
			map.controls[google.maps.ControlPosition.TOP_LEFT].push(document.getElementById('layerPanel'));
			map.controls[google.maps.ControlPosition.TOP_RIGHT].push(document.getElementById('faqPanel'));

			var rightHandControls = document.getElementById('sitePanel');
			map.controls[google.maps.ControlPosition.TOP_RIGHT].push(rightHandControls);
			
			resizeControls();

			var pollutantDiv = document.getElementById('pollutantDiv');
			map.controls[google.maps.ControlPosition.LEFT_TOP].push(pollutantDiv);
			var overallCaptionDiv = document.getElementById('overallCaptionDiv');
			map.controls[google.maps.ControlPosition.TOP_CENTER].push(overallCaptionDiv);

			var measuredAtDiv = document.getElementById('measuredAtDiv');
			map.controls[google.maps.ControlPosition.BOTTOM_LEFT].push(measuredAtDiv);
			mapBounds = new google.maps.LatLngBounds(
				new google.maps.LatLng(mapBoundsMinLat, mapBoundsMinLon),
				new google.maps.LatLng(mapBoundsMaxLat, mapBoundsMaxLon)
			);
			// Controlling the extents of the map
			boundLimits = {
				maxLat: mapBounds.getNorthEast().lat(),
				maxLng: mapBounds.getNorthEast().lng(),
				minLat: mapBounds.getSouthWest().lat(),
				minLng: mapBounds.getSouthWest().lng()
			};

			// Event handler to avoid panning away from the airTEXT region
			var lastValidCenter = map.getCenter();
			var newLat, newLng;
			google.maps.event.addListener(map, 'center_changed', function() {
				center = map.getCenter();
				if (mapBounds.contains(center)) {
					// still within valid bounds, so save the last valid position
					lastValidCenter = map.getCenter();
					return;
				}

				newLat = lastValidCenter.lat();
				newLng = lastValidCenter.lng();
				if (center.lng() > boundLimits.minLng && center.lng() < boundLimits.maxLng) {
					newLng = center.lng();
				}
				if (center.lat() > boundLimits.minLat && center.lat() < boundLimits.maxLat) {
					newLat = center.lat();
				}
				map.panTo(new google.maps.LatLng(newLat, newLng));
			});

			google.maps.event.addListener(map, 'zoom_changed', function() {
				if (document.getElementById("caroption").checked === true) {
					if ((map.getZoom() < 15 && currentZoom >= 15)) {
						carLayer.forEach(function(feature) {
							carLayer.overrideStyle(feature, {
								strokeWeight: 1
							});
						});
					}
					if ((map.getZoom() >= 15 && currentZoom < 15)) {
						carLayer.forEach(function(feature) {
							carLayer.overrideStyle(feature, {
								strokeWeight: 4
							});
						});
					}
				}
				currentZoom = map.getZoom();
			});

			//Set up tooltips for pollutant radio button labels  
			mapPollutantCodeNames = [];
			$(".pollutantLabel").each(function() {
				var nextCodeName = $(this).attr('for'); // the For attribute is a pollutant code name
				if (typeof(nextCodeName) != "undefined") {
					mapPollutantCodeNames.push(nextCodeName);
					$(this).attr('title', getPollutantObject(nextCodeName).longName);
				}
			});

			//Attach event handler to pollutant radio buttons
			$("input[name='pollutantRadios']").change(onPollutantRadiosChange);
			mapLoaded = true;

			var params = getParams(window.location.href);
			initialMode = "";
			
			if ((params.mode == "average") || (params.mode == "road")) {
				document.getElementById("average").checked = true;
				var roadStart = (params.mode == "road");
				setTimeout(function() {
					showTimePeriod('average');
					if (roadStart) {
						//document.getElementById("caroption").disabled = false;
						document.getElementById("caroption").checked = true;
						showCars = true;
						enableRoads(true);
					} else {
						enableRoads(false);
					}
				}, 2500);
			}
		
			if (params.mode == "sources") {
				document.getElementById("source").checked = true;
				showTimePeriod('source');
				initialMode = params.mode;
			}

			if ((document.getElementById("current").checked === true) || ((document.getElementById("average").checked === true) && (document.getElementById("caroption").checked === false))) {
				if (params.poll == "PM2_5") {
					document.getElementById("PM2_5").checked = true;
					onPollutantRadiosChange();
				}
			}

			if (params.regulatorynetworks == "hide") {
				document.getElementById("otheroption").checked = false;
				document.getElementById("schooloption").checked = false;
			}
			
			
			
			loadedMode = true;

			var autoComplete = new google.maps.places.AutocompleteService({
				strictBounds: true
			});
			var input = document.querySelector('#searchInputTextBox');
			//var result = document.querySelector('#result');

			var getPlaceAutocomplete = function getPlaceAutocomplete(value) {
				// Get the Places predictions based on the text, within the bounds of the project (The Google Place API uses this but doesn't preclude places outside)
				autoComplete.getPlacePredictions({
					input: value,
					sessionToken: sessionToken,
					bounds: mapBounds,
					strictBounds: true,
					componentRestrictions: {
						country: 'gb',
					},
				}, function(data) {
					if (data !== null) {
						data.forEach(function(item) {
							if (document.getElementById('autocomplete-list').childElementCount < 5) {

								var b = document.createElement("DIV");
								b.innerHTML = item.description;
								b.setAttribute("class", "searchOptionBasic");
								b.innerHTML += "<input type='hidden' value='" + item.place_id + "'>";

								b.addEventListener("click", function(e) {
									var request = {
										placeId: this.getElementsByTagName("input")[0].value,
										fields: ['geometry', 'name'],
										sessionToken: sessionToken
									};

									var service = new google.maps.places.PlacesService(map);

									service.getDetails(request, function(place, status) {
										if (status === google.maps.places.PlacesServiceStatus.OK) {
											if ((place.geometry.location.lat() >= mapBoundsMinLat) && (place.geometry.location.lat() <= mapBoundsMaxLat) && (place.geometry.location.lng() >= mapBoundsMinLon) && (place.geometry.location.lng() <= mapBoundsMaxLon)) {
												map.fitBounds(place.geometry.viewport);
												closeAllLists();
												document.getElementById('searchControls').style.display = 'none';
												document.getElementById("searchInputTextBox").value = "";
												document.getElementById("searchLocationButton").src = './icons/SearchPink.png';
												searchPlaceShown = true;
												var pos = {
													lat: place.geometry.location.lat(),
													lng: place.geometry.location.lng()
												};

												var latLng = new google.maps.LatLng(place.geometry.location.lat(), place.geometry.location.lng());

												if ((searchLocationPopup != null) && (searchLocationPopup != 'undefined')) {
													searchLocationPopup.setMap(null);
												}
												find_closest_pod(pos);
												searchLocationPopup = new Popup(latLng, place.name, 'white', "");
												searchLocationPopup.setMap(map);

											} else {
												//Warn the user that their location is outside of the map bounds
												document.getElementById('searchLocationWarning').style.display = 'block';
												document.getElementById('searchLocationWarning').style.maxWidth = ($(window).width() - 100).toString() + "px";
												document.getElementById("searchLocationWarning").innerHTML = "Unable to show " + place.name + ".<br>It is outside the project extents.";
												document.getElementById('searchControls').style.display = 'none';
												document.getElementById("searchInputTextBox").value = "";
											}
										}
									});


									if (currentInfoWindow !== null) {
										currentInfoWindow.setMap(null);
									}


								});
								document.getElementById('autocomplete-list').appendChild(b);

							}
						});
					}
				});
			};

			input.addEventListener('keyup', function() {
				var value = input.value;
				if (document.getElementById('autocomplete-list') !== null) {
					if (document.getElementById('autocomplete-list').childElementCount < 5) {
						getPlaceAutocomplete(value);

					}
				}
			});

			input.addEventListener('focus', function() {
				document.getElementById("searchLocationWarning").innerHTML = "";
				document.getElementById("searchLocationWarning").style.display = 'none';
			});
			


			function closeAllLists(elmnt) {
				/*close all autocomplete lists in the document,
				except the one passed as an argument:*/
				var x = document.getElementsByClassName("autocomplete-items");
				for (var i = 0; i < x.length; i++) {
					if (elmnt != x[i]) {
						x[i].parentNode.removeChild(x[i]);
					}
				}
			}
		}

		function sectionSizer() {
			var acc = document.querySelectorAll(".faqAccordion, .legendAccordion");
			var i;
			for (i = 0; i < acc.length; i++) {
				
				var panel = acc[i].nextElementSibling;
				if (acc[i].classList.contains("legendAccordion")) {
					if (panel.scrollHeight === 94) {
						panel.style.maxHeight = "100px";
					} else if (panel.scrollHeight === 0) {
						panel.style.maxHeight = null;
					} else {
						panel.style.maxHeight = panel.scrollHeight + "px";
					}
				} else {
					panel.style.maxHeight = null;
				}
			if (!sectionSizerEventsLoaded) {
				acc[i].addEventListener("click", function() {
					var panel = this.nextElementSibling;
					if (panel.style.maxHeight) {
						this.classList.remove("active");
						panel.style.maxHeight = null;
					} else {
						this.classList.add("active");
						panel.style.maxHeight = panel.scrollHeight + "px";
					}
				});
				
			}
			}
			sectionSizerEventsLoaded = true;
		}
		
		function initialPopup (mode) {
			
			var alreadyShown = false;
			var popupText="";
			var popupTitle=""
			var storageKey="";
			var hidePopup='<div><label><input type="checkbox" id="hidePopup" />Don&#39;t show this again</label></div>';
			
			switch (mode) {
				case "sources":
					popupText='<div style="line-height:1.1em;">This map shows the contribution of different sources of nitrogen oxides (NOx) pollution at monitoring sites across the city in 2019.</div><br><br><div style="line-height:1.1em;">Click on a monitoring site &hyphen; Breathe London <svg height="20" width="20" style="margin-top:-10px;margin-bottom:-4px;"><circle cx="10" cy="10" r="6" stroke="#F00379" stroke-width="1" fill="white"></circle></svg> or Regulatory <svg height="20" width="20" style="margin-top:-10px;margin-bottom:-4px;"><path d="M 10,17 17,10 10,3 3,10 z" style="fill:white;stroke:#444;stroke-width:1" ></path></svg> &hyphen; to learn more about the main sources contributing to pollution at that location. </div>';
					popupTitle = "Breathe London - Sources";
					storageKey = "_sources_";
					alreadyShown = sourceDialogShown;
					sourceDialogShown = true;
					break;
			}

			if (storageKey !== "" && !alreadyShown) 
			{
				var sHtml = popupText; 
				if (typeof(Storage) !== "undefined") 			
				{
					var resp = null;
					try {
						resp = localStorage.getItem(storageKey);
					} catch (e) {
						resp = null;
					}
					if (resp === null)
					{
						sHtml = sHtml + '<br><br>' + hidePopup  ;
						showExplanatoryDialog(sHtml, popupTitle, storageKey);
						popupShown = true;
					} 
				} else {
					showExplanatoryDialog(sHtml, popupTitle,"");
					popupShown = true;
				}
			}
		}

		function onPollutantRadiosChange() {
			var thePollutantCode = $("input[name='pollutantRadios']:checked").val();
			currentMapPollCodeName = thePollutantCode;

			enableDisableLHSControls();
			updateMapAndLegend(thePollutantCode);
			var pollutantObject = getPollutantObject(currentMapPollCodeName);
			var pollShortName = pollutantObject.shortName;

			document.getElementById("pollName").innerHTML = pollShortName;
			if (currentMapPollCodeName == "NOx") {
				document.getElementById("graphPollutant").innerHTML = "NOx pollution sources";
			} else {
				document.getElementById("graphPollutant").innerHTML = pollShortName + " <i>(" + pollutantObject.unitsHtml + ")</i>";
			}
			reselectSite();
		}

		function resizeControls() {
			var showSite = false;
			var showFAQ = false;
			if (document.getElementById("sitePanel").style.display === "block") {
				hideShowPanelsAndMapButtons("sitePanel");
				showSite = true;
			} else if (document.getElementById("faqPanel").style.display === "block") {
				hideShowPanelsAndMapButtons("faqPanel");
				showFAQ = true;
			} else {
				hideShowPanelsAndMapButtons("");
			}

			if (useSmallScreen()) {

				// If on phone add a close button, if not add a open/close button beyond the right edge -->
				panelPhoneStyle('layerPanel', 'layerDiv', false);
				panelPhoneStyle('sitePanel', 'SiteDiv', showSite);
				panelPhoneStyle('faqPanel', 'faqDiv', showFAQ);

				document.getElementById('closeLHSonPhone').style.display = "block";
				document.getElementById('closeLHSTab').style.display = "none";
				document.getElementById("headingLayers").style.marginLeft = "auto";
				document.getElementById("headingLayers").style.marginRight = "auto";
				document.getElementById('phoneHeadingLayers').style.display = "block";
				document.getElementById("averageDiv").style.marginLeft = "auto";
				document.getElementById("averageDiv").style.marginRight = "auto";
				
			} else {

				panelDesktopStyle('layerPanel', 'layerDiv', "block", "left",  "220px", true);
				panelDesktopStyle('sitePanel', 'SiteDiv', "none", "right", "280px", showSite);
				panelDesktopStyle('faqPanel', 'faqDiv', "none", "right", "305px", showFAQ);

				document.getElementById('closeLHSonPhone').style.display = "none";
				document.getElementById('closeLHSTab').style.display = "block";
				document.getElementById("headingLayers").style.marginLeft = "0px";
				document.getElementById("headingLayers").style.marginRight = "0px";
				document.getElementById('phoneHeadingLayers').style.display = "none";
				document.getElementById("averageDiv").style.marginLeft = "0px";
				document.getElementById("averageDiv").style.marginRight = "0px";
			}

		}


		function searchSite() {
			var firstChar = document.getElementById("searchInputTextBox").value;
			var foundSite = null;
			if (firstChar <= '9' && firstChar >= '0') {
				foundSite = sites.find(function(e) {
					return (e.feature.properties.UniqueID === document.getElementById("searchInputTextBox").value);
				});
			} else {
				foundSite = sites.find(function(e) {
					return (e.feature.properties.Name === document.getElementById("searchInputTextBox").value);
				});
			}
			if (foundSite !== null) {
				if (foundSite.feature.properties.Network === "LAQN") {
					selectSite(foundSite, featureType.LAQN, true);
				} else if (foundSite.feature.properties.Network === "AQE") {
					selectSite(foundSite, featureType.AQE, true);
				} else if (foundSite.feature.properties.Network === "FIA") {
					selectSite(foundSite, featureType.FIA, true);
				} else {
					selectSite(foundSite, featureType.AQMESH, true);
				}
			} else {

			}
		}


		function createMarker(site) {
			//NB our coordinates are Lat, Long in accordance with GeoJSON specification
			var latLng = new google.maps.LatLng(site.feature.geometry.coordinates[1], site.feature.geometry.coordinates[0]);

			var markerOptions = {
				position: latLng,
				map: map
			};
			markerOptions.title = site.feature.properties.Name;
			site.marker = new google.maps.Marker(markerOptions);

			site.marker.addListener('click', function() {
				if (site.feature.properties.Network === "LAQN") {
					selectSite(site, featureType.LAQN, false);
				} else if (site.feature.properties.Network === "AQE") {
					selectSite(site, featureType.AQE, false);
				} else if (site.feature.properties.Network === "FIA") {
					selectSite(site, featureType.FIA, false);
				} else {
					selectSite(site, featureType.AQMESH, false);
				}
			});
		}

		/* Given the code name return a pollutant object with long name and WHO guidelines */
		function getPollutantObject(codeName) {
			var guidelinePreamble = "<p>The World Health Organization's (WHO) Air Quality Guidelines (AQG) are based on an extensive review of air pollutants' impact on human health. These levels represent targets for governments in order to protect people from both long- and short-term effects of air pollution.</p>";
			var pollutant = {};
			pollutant.codeName = codeName;
			pollutant.average = "hourly";
			pollutant.averageName = "hourly average";
			switch (codeName) {
				/* the pollutants listed in the deliverables */
				case "CO2":
					pollutant.longName = "Carbon Dioxide (CO2)";
					pollutant.shortName = codeName;
					pollutant.ValidRange = {
						LowerBound: 200,
						UpperBound: 2000
					};
					pollutant.hasGuidelines = false;
					pollutant.units = "ppm";
					pollutant.explanationHtml = '<p class="pollExplanationHeader"><b>' + pollutant.longName + '</b></p>';
					pollutant.explanationHtml = pollutant.explanationHtml + '<p class="pollExplanation">';
					pollutant.explanationHtml = pollutant.explanationHtml + pollutant.longName + ' is a long-lived greenhouse gas that is the dominant contributor to climate emissions on a global scale. The transportation and energy sectors are the largest contributors to CO2 emissions.';
					pollutant.explanationHtml = pollutant.explanationHtml + '<a href="https://www.who.int/sustainable-development/transport/health-risks/climate-impacts/en/" target="_blank" rel="noopener">(source)</a></p>';
					break;
				case "NOx":
					pollutant.longName = "Nitrogen Oxides (NOx)";
					pollutant.shortName = "NOx";
					pollutant.ValidRange = {
						LowerBound: -39,
						UpperBound: 2884
					};
					pollutant.hasGuidelines = false;
					pollutant.units = "ug/m3 (as NO2)";
					pollutant.unitsHtml = "&mu;g/m&sup3; (as NO2)";
					pollutant.explanationHtml = '<p class="pollExplanationHeader"><b>' + pollutant.longName + '</b></p>';
					pollutant.explanationHtml = pollutant.explanationHtml + '<p class="pollExplanation">';
					pollutant.explanationHtml = pollutant.explanationHtml + pollutant.longName + ' is the generic term for a group of highly reactive gases, all of which contain nitrogen and oxygen in varying amounts. NOx is involved in the formation of ground-level ozone, which can cause respiratory problems. NOx and pollutants formed from NOx can be transported over long distances.';
					pollutant.explanationHtml = pollutant.explanationHtml + '<a href="https://nepis.epa.gov/Exe/ZyPDF.cgi/P10006ZO.PDF?Dockey=P10006ZO.PDF" target="_blank" rel="noopener">(source)</a></p>';
					break;
				case "NO":
					pollutant.longName = "Nitrogen Monoxide (NO)";
					pollutant.shortName = codeName;
					pollutant.hasGuidelines = false;
					pollutant.units = "ug/m3";
					pollutant.explanationHtml = "";
					break;
				case "NO2":
					pollutant.longName = "Nitrogen Dioxide (NO2)";
					pollutant.shortName = codeName;
					pollutant.ValidRange = {
						LowerBound: 0,
						UpperBound: 961
					};
					pollutant.hasGuidelines = true;
					pollutant.units = "ug/m3";
					pollutant.explanationHtml = '<p class="pollExplanationHeader"><b>' + pollutant.longName + '</b></p>';
					pollutant.explanationHtml = pollutant.explanationHtml + '<p class="pollExplanation">';
					pollutant.explanationHtml = pollutant.explanationHtml + pollutant.longName + ' is primarily emitted into the air from burning fuel and emissions from cars, trucks and buses, power plants, and off-road equipment. Breathing NO2 can irritate airways in the respiratory system and short periods of exposure can aggravate respiratory diseases, particularly asthma.';
					pollutant.explanationHtml = pollutant.explanationHtml + '<a href="https://www.epa.gov/no2-pollution/basic-information-about-no2#What%20is%20NO2" target="_blank" rel="noopener">(source)</a></p>';
					pollutant.guidelines = [];
					pollutant.guidelines.push({
						name: "WHO annual health guideline",
						shortName: "Annual",
						value: 40,
						average: "annual",
						colour: newmarkercolours[2],
						explanationHtml: "<p><b>WHO annual air quality guideline for NO2</b></p>" + guidelinePreamble + "<p>Long-term exposure above this is known to cause the development of respiratory illness and decreased lung function among children. <a href=\"http://www.euro.who.int/__data/assets/pdf_file/0004/193108/REVIHAAP-Final-technical-report-final-version.pdf?ua=1\" target=\"_blank\" rel=\"noopener\">Recent evidence</a> suggests health could be impacted below these levels.<p>"
					});
					pollutant.guidelines.push({
						name: "WHO hourly health guideline",
						shortName: "Hourly",
						value: 200,
						average: "hourly",
						colour: newmarkercolours[3],
						explanationHtml: "<p><b>WHO hourly air quality guideline for NO2</b></p>" + guidelinePreamble + "<p>Exposure to concentrations above this for an hour or more could increase rates of hospitalizations and emergency room visits and affect lung function among susceptible populations such as asthmatics and children. <a href=\"http://www.euro.who.int/__data/assets/pdf_file/0004/193108/REVIHAAP-Final-technical-report-final-version.pdf?ua=1\" target=\"_blank\" rel=\"noopener\">Recent evidence</a> suggests health could be impacted below these levels.</p>"
					});
					break;
				case "O3":
					pollutant.longName = "Ozone (O3)";
					pollutant.shortName = codeName;
					pollutant.ValidRange = {
						LowerBound: -20,
						UpperBound: 300
					};
					pollutant.hasGuidelines = true;
					pollutant.units = "ug/m3";
					pollutant.explanationHtml = '<p class="pollExplanationHeader"><b>' + pollutant.longName + '</b></p>';
					pollutant.explanationHtml = pollutant.explanationHtml + '<p class="pollExplanation">';
					pollutant.explanationHtml = pollutant.explanationHtml + pollutant.longName + ' naturally occurs in the upper atmosphere and protects earth from the sun\'s rays. However, ground-level ozone is a colourless gas that can harm human health. Ozone forms when NOx and volatile organic compounds (VOCs) react in sunlight and is a strong respiratory irritant.';
					pollutant.explanationHtml = pollutant.explanationHtml + '<a href="https://www.airnow.gov/index.cfm?action=pubs.aqiguideozone" target="_blank" rel="noopener">(source)</a></p>';
					pollutant.guidelines = [];
					pollutant.guidelines.push({
						name: "WHO 8-hourly health guideline",
						shortName: "8-hourly",
						value: 100,
						average: "8-hourly",
						colour: shortTermColour,
						explanationHtml: "<p><b>WHO 8-hourly air quality guideline for O3</b></p>" + guidelinePreamble + "<p>Exposure to concentrations above this for even a few days is known to cause small increase in risk of death, as well as increase risk of respiratory disease, hospitalizations, and emergency room visits.</p>"
					});
					break;
				case "PM2_5":
					pollutant.longName = "Particulate Matter (PM2.5)";
					pollutant.shortName = "PM2.5";
					pollutant.ValidRange = {
						LowerBound: -10,
						UpperBound: 500
					};
					pollutant.hasGuidelines = true;
					pollutant.units = "ug/m3";
					pollutant.explanationHtml = '<p class="pollExplanationHeader"><b>' + pollutant.longName + '</b></p>';
					pollutant.explanationHtml = pollutant.explanationHtml + '<p class="pollExplanation">';
					pollutant.explanationHtml = pollutant.explanationHtml + 'Particulate matter (PM) is made up of small airborne particles like dust, soot, and drops of liquids. PM2.5 is fine particulate matter that is less than 2.5&mu;m in diameter and is a common proxy indicator for air pollution and is typically emitted from vehicles, power generation, and industry. PM2.5 exposure causes cardiovascular, respiratory disease, and cancers.';
					pollutant.explanationHtml = pollutant.explanationHtml + '<a href="https://www.who.int/news-room/fact-sheets/detail/ambient-(outdoor)-air-quality-and-health" target="_blank" rel="noopener">(source)</a></p>';
					pollutant.average = "daily";
					pollutant.averageName = "daily average";
					pollutant.guidelines = [];
					pollutant.guidelines.push({
						name: "WHO annual health guideline",
						shortName: "Annual",
						value: 10,
						average: "annual",
						colour: longTermColour,
						explanationHtml: "<p><b>WHO annual air quality guideline for PM2.5</b></p>" + guidelinePreamble + "<p>Long-term exposure to pollution above this is known to cause the development of heart disease, cancer and ensuing death. <a href=\"http://www.euro.who.int/__data/assets/pdf_file/0004/193108/REVIHAAP-Final-technical-report-final-version.pdf?ua=1\" target=\"_blank\" rel=\"noopener\">Recent evidence</a> suggests health could be impacted below these levels.</p>"
					});
					pollutant.guidelines.push({
						name: "WHO daily health guideline",
						shortName: "Daily",
						value: 25,
						average: "daily",
						colour: shortTermColour,
						explanationHtml: "<p><b>WHO daily air quality guideline for PM2.5</b></p>" + guidelinePreamble + "<p>Exposure to concentrations above this for even a few days is associated with increased emergency room visits, hospitalizations for respiratory or cardiovascular disease and deaths.</p>"
					});
					break;
				case "PM10":
					pollutant.longName = "Particulate Matter (PM10)";
					pollutant.shortName = codeName;
					pollutant.ValidRange = {
						LowerBound: -10,
						UpperBound: 1000
					};
					pollutant.hasGuidelines = true;
					pollutant.units = "ug/m3";
					pollutant.explanationHtml = '<p class="pollExplanationHeader"><b>' + pollutant.longName + '</b></p>';
					pollutant.explanationHtml = pollutant.explanationHtml + '<p class="pollExplanation">';
					pollutant.explanationHtml = pollutant.explanationHtml + 'Particulate matter (PM) is made up of small airborne particles like dust, soot, and drops of liquids. PM10 is coarse particulate matter 10&mu;m or less in diameter and commonly emitted from vehicles, power generation, and industry. PM10 exposure causes cardiovascular, respiratory disease, and cancers.';
					pollutant.explanationHtml = pollutant.explanationHtml + '<a href="https://www.who.int/news-room/fact-sheets/detail/ambient-(outdoor)-air-quality-and-health" target="_blank" rel="noopener">(source)</a></p>';
					pollutant.average = "daily";
					pollutant.averageName = "daily average";
					pollutant.guidelines = [];
					pollutant.guidelines.push({
						name: "WHO annual health guideline",
						shortName: "Annual",
						value: 20,
						average: "annual",
						colour: longTermColour,
						explanationHtml: "<p><b>WHO annual air quality guideline for PM10</b></p>" + guidelinePreamble + "<p>Long-term exposure above this is known to affect health, causing impacts such as the development of heart disease, cancer and ensuing death.</p>"
					});
					pollutant.guidelines.push({
						name: "WHO daily health guideline",
						shortName: "Daily",
						value: 50,
						average: "daily",
						colour: shortTermColour,
						explanationHtml: "<p><b>WHO daily air quality guideline for PM10</b></p>" + guidelinePreamble + "<p>Exposure to concentrations above this for even a few days is associated with increased emergency room visits, hospitalizations for respiratory or cardiovascular disease and deaths.</p>"
					});
					break;
				case "PM1":
					pollutant.longName = "Particulate Matter (PM1)";
					pollutant.shortName = codeName;
					pollutant.hasGuidelines = false;
					pollutant.explanationHtml = "";
					pollutant.units = "ug/m3";
					break;
				case "PC":
					pollutant.longName = "Particle Count (PC)";
					pollutant.shortName = "PC";
					pollutant.ValidRange = {
						LowerBound: -5,
						UpperBound: 300
					};
					pollutant.hasGuidelines = false;
					pollutant.explanationHtml = "";
					pollutant.units = "particles/cm3";
					pollutant.unitsHtml = "particles/cm&sup3;";
					break;
					/* we also have TSP and PM4 measured on the pods */
				default:
					throw "Unrecognised pollutant name " + codeName;
			}
			if (typeof pollutant.unitsHtml === 'undefined') {
				if (pollutant.units === "ug/m3") {
					pollutant.unitsHtml = "&mu;g/m&sup3;";
				} else {
					pollutant.unitsHtml = pollutant.units;
				}
			}

			return pollutant;
		}

		function averageForSite(pollutantObject, site) {
			var value = -999;
			if (pollutantObject.codeName !== "NOx") {
				var pollAPI = site.feature.properties[pollutantObject.codeName];

				if (typeof pollAPI === 'undefined') {
					//Pollutant is not measured at site
					value = -999;
				} else {
					var aver = pollAPI.AverageSoFar;
					if (aver > -999) {
						value = aver;
					} else {
						value = -999;

					}
				}
			}
			return value;
		}

		function validatedValueForSite(pollutantObject, site) {
			var value = -999;
			var pollAPI = site.feature.properties[pollutantObject.codeName];
			if (typeof pollAPI === 'undefined') {
				//Pollutant is not measured at site
				return value;
			}
			if (typeof pollAPI.Measurements === 'undefined') {
				//No valid measurements found
				return value;
			}
			var dteMeasuredAt = getMeasuredAtDate();
			if (typeof dteMeasuredAt === 'undefined') {
				//Data not loaded yet
				return value;
			}
			// Select measurement for correct date-time
			var measuredAtGetTime = getMeasuredAtDate().getTime();
			pollAPI.Measurements.forEach(function(nextMeas) {
				// 60 second margin of error - values are in milliseconds
				if (Math.abs(measuredAtGetTime - setDateStringAsGMT(nextMeas.DateTime).getTime()) < 60000) {
					if (typeof nextMeas.Value === 'undefined') {} else if (nextMeas.Value != -999) {
						value = nextMeas.Value;
					}
				}
			});

			return value;
		}

		function networkCaptionFromCode(networkCode) {
			switch (networkCode.toUpperCase()) {
				case 'C40':
					return "Breathe London";
				case 'LAQN':
					return "London Air Quality Network";
				case 'AQE':
					return "Air Quality England";
				case 'FIA':
					return "School Streets";
				default:
					return networkCode;
			}
			return (networkCode === "C40" ? "Breathe London" : networkCode);
		}

		//updateMarker updates the marker's colour and info window caption based on the selected pollutant
		function updateMarker(site, currentPollObject) {

			var strokecolour = NoLevelBorderColour;
			var markercolour = NoColour;
			var zindex;

			//Set the shape of the marker based on the type
			var markerscale;
			var markerstrokeweight;
			var shape;
			var networkCode = site.feature.properties.Network;
			if ((networkCode === "LAQN") || (networkCode === "AQE") || (networkCode === "FIA")) {
				var otherMonitorsCheckBox;
				if (networkCode === "FIA") {
					shape = triangle_shape;
					otherMonitorsCheckBox = document.getElementById("schooloption");
				} else {
					shape = diamond_shape;
					otherMonitorsCheckBox = document.getElementById("otheroption");
				}
				
				if (otherMonitorsCheckBox.checked === false) {
					//Changed from setting the markerscale to zero (this fixes an issue where occasionally a "hidden" marker would be selected
					//This happened around the wetlands (Barnes Wetlands (RI2)/Wetland Centre), and recently around the roads (e.g. IKEA/A406)
					site.marker.setVisible(false);
					return;
				}
				if (currentPollObject.shortName !== "NOx") {
					if (typeof site.feature.properties[currentPollObject.codeName] == "undefined") {

						site.marker.setVisible(false);

						return;
					}
				} else {
					if (typeof site.feature.properties.NOX == "undefined") {

						site.marker.setVisible(false);

						return;
					} else if (typeof site.feature.properties.NOX.Sources == "undefined") {
						site.marker.setVisible(false);

						return;
					}
				}
				markerscale = 8;
				markerstrokeweight = 1;
				zindex = 8000;
			} else {
				shape = circle_shape;
				var blMonitorsCheckBox = document.getElementById("bloption");
				if (blMonitorsCheckBox.checked === false) {
					site.marker.setVisible(false);
					return;
				}
				//If the site doesn't have any data for this pollutant, don't shown it
				if (currentPollObject.shortName !== "NOx") {
					if (typeof site.feature.properties[currentPollObject.codeName] == "undefined") {

						site.marker.setVisible(false);

						return;
					}
				} else {
					if (typeof site.feature.properties.NOX == "undefined") {

						site.marker.setVisible(false);

						return;
					} else if (typeof site.feature.properties.NOX.Sources == "undefined") {
						site.marker.setVisible(false);

						return;
					}
				}
				markerscale = 10;
				markerstrokeweight = 1;
				zindex = 9000;
			}

			var value;
			if (dataMode === "current") {
				value = validatedValueForSite(currentPollObject, site);
				if (typeof value === 'undefined') {
					value = -999;
					throw "Unrecognised pollutant code name " + currentPollObject.codeName;

				}
			} else {
				value = averageForSite(currentPollObject, site);
			}




			if (value !== -999) {
				if ((networkCode === "LAQN") || (networkCode === "AQE") || (networkCode === "FIA")) {
					numOtherMonitorsWithDataForPoll += 1;
				} else {
					numBLMonitorsWithDataForPoll += 1;
				}
			}
			var isAverage = document.getElementById("average").checked;

			if ((site.feature.properties.LocationEndDate !== undefined) && (dataMode == "current")) {
				markercolour = '#dadada';
			} else {

				if (currentPollObject.shortName == "NO2") {
					markercolour = colourFromNO2Value(value);
				} else if (currentPollObject.shortName == "PM2.5") {
					markercolour = colourFromPM25Value(value);
				} else {
					markercolour = "white";
				}
			}

			if ((networkCode === "LAQN") || (networkCode === "AQE") || (networkCode === "FIA")) {
				if (dataMode == "source") 
				{
					strokecolour = "black";
				} else {
					strokecolour = NoLevelBorderColour;
				}
			} else {
				strokecolour = BreatheLondonPinkColour;
				if (dataMode == "source") 
				{
					markerstrokeweight = 2;
				}
			}
			
			if (currentPollObject.shortName !== "NOx") {
				if (value === -999) {
					zindex = 7000;
				}
			}


			if ((site.feature.properties.LocationEndDate !== undefined) && (dataMode == "current")) {

				//Set the marker

				site.marker.setIcon({
					anchor: new google.maps.Point(11, 11),
					url: './icons/HistoricalMonitor.svg'

				});



			} else {

				site.marker.setIcon({
					path: shape,
					fillOpacity: markeropacity,
					scale: markerscale,
					strokeWeight: markerstrokeweight,
					strokeColor: strokecolour,
					fillColor: markercolour
				});
			}

			site.marker.setVisible(true);

			site.marker.setZIndex(zindex);
		}

		function getMeasuredAtDate() {
			if (typeof aqmeshData === 'undefined') {
				return undefined;
			} else {
				//All dates should be in GMT, except when they are being displayed (in BST or GMT)
				return setDateStringAsGMT(aqmeshData.MeasuredDate);
			}
		}

		function formattedMeasuredAtTime() {
			if (typeof aqmeshData === 'undefined') {
				return "";
			} else {
				var dteMeasuredAt = getMeasuredAtDate();
				return localTimeString(dteMeasuredAt);
			}
		}

		function formattedMeasuredAt() {
			if (typeof aqmeshData === 'undefined') {
				return "";
			} else {
				var dteMeasuredAt = getMeasuredAtDate();
				//Hack because cross-browser support for date formatting is patchy
				var monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
				var timeString = formattedMeasuredAtTime();

				return timeString + ' ' +
					dteMeasuredAt.getDate() + ' ' +
					monthNames[dteMeasuredAt.getMonth()];
			}
		}

		function setDisplayDates(site, NumValidHours, poll) {
			//Current Data gets the current date time (or past location, Undergoing quality assurance and control, no to or from)
			//Average (to and from), car (nothing)
			//Source (fixed to and from)
			if (dataMode == "current") {
				if ((site.feature.properties.LocationEndDate !== undefined) || (NumValidHours === -999)) {
					document.getElementById('monitorTime').innerHTML ="";
				} else {
					document.getElementById('monitorTime').innerHTML =formattedMeasuredAt2(site);
				}
				document.getElementById('monitorTime2').innerHTML = "";
			} else if (dataMode == "average") {
				if (selectedSiteType == featureType.GOOGLE) {
					document.getElementById('monitorTime').innerHTML = "";
					document.getElementById('monitorTime2').innerHTML = "";
				} else {
					document.getElementById('monitorTime').innerHTML = "From: <b>" + formatDateTimeForRHS(new Date(site.feature.properties.LocationStartDate), site, "start") + "</b>";
					document.getElementById('monitorTime2').innerHTML = "To: <b>"+formatDateTimeForRHS(new Date(site.feature.properties[poll].LastUpdatedDate), site, "end") + "</b>";
				}
			} else {
				//Source - hardcoded dates
				document.getElementById('monitorTime').innerHTML = "From: <b>1st April 2019</b>";
				document.getElementById('monitorTime2').innerHTML = "To: <b>12th December 2019</b>";
			}
		}
		
		function formattedMeasuredAt2(site) {
			if (typeof aqmeshData === 'undefined')  {
				return "";
			} else {
				var dteMeasuredAt = getMeasuredAtDate();
				return formatDateTimeForRHS(dteMeasuredAt, site, "");
			}
		}

		function formatDateTimeForRHS(dateToFormat, site, time) {
			var isDate = true;
			if (site.feature.properties.LocationEndDate !== undefined) {
				if (time === "start") {
					dateToFormat = new Date(site.feature.properties.LocationStartDate);
				} else if (time === "end") {
					dateToFormat = new Date(site.feature.properties.LocationEndDate);
				} else {
					isDate = false;
				}
			} else {
				if (currentMapPollCodeName === "NO2") {
					if (typeof site.feature.properties.NO2 == 'undefined') {
						isDate = false;
					} else if (site.feature.properties.NO2.NumValidHoursSoFar === -999) {
						isDate = false;
					}
				} else if (currentMapPollCodeName === "PM2_5") {
					if (typeof site.feature.properties.PM2_5 == 'undefined') {
						isDate = false;
					} else if (site.feature.properties.PM2_5.NumValidHoursSoFar === -999) {
						isDate = false;
					}
				}
			}
			if (isDate) {
				return GMTtoUKTimeFormat(dateToFormat, 'Do MMMM YYYY HH:mm');
			} else {
				return "-";
			}
		}

		//Called when the json has been read or when the map pollutant selector has been changed
		var numPodsWithDataForPoll;
		var numBLMonitorsWithDataForPoll;
		var numOtherMonitorsWithDataForPoll;

		function updateMapAndLegend(currentPollCode) {

			currentMapPollCodeName = currentPollCode;
			var currentPollObject = getPollutantObject(currentPollCode);

			if (currentPollCode === "NO2") {
				document.getElementById('NO2table').style.display = 'block';
				document.getElementById('PM25table').style.display = 'none';
			} else {
				document.getElementById('NO2table').style.display = 'none';
				document.getElementById('PM25table').style.display = 'block';
			}

			//Updates the markers based on their new values
			numBLMonitorsWithDataForPoll = 0;
			numOtherMonitorsWithDataForPoll = 0;

			for (i = 0; i < sites.length; i++) {
				updateMarker(sites[i], currentPollObject);
			}
			setMeasuredAt();

		}

		function setMeasuredAt() {
			if (typeof aqmeshData !== 'undefined') {
				var measuredAtText = "Map by CERC   Measured at " + formattedMeasuredAt() + " (UK time)";
				if (typeof numBLMonitorsWithDataForPoll !== 'undefined') {
					measuredAtText = measuredAtText + " - BL" + numBLMonitorsWithDataForPoll + "/" + numBLMonitors;
				}
				if (typeof numOtherMonitorsWithDataForPoll !== 'undefined') {
					measuredAtText = measuredAtText + " - O" + numOtherMonitorsWithDataForPoll + "/" + numOtherMonitors;
				}
				$("#measuredAt").text(measuredAtText);

				var sOverallCaption = (($(window).width() < 700) ? "Current" : "Current air quality");
				sOverallCaption = sOverallCaption + " (" + formattedMeasuredAtTime() + ")";
				$("#overallCaption").html(sOverallCaption);
			}
		}


		function showMapPollutantDialog() {
			showPollutantDialog(mapPollutantCodeNames);
		}

		function showGraphPollutantDialog() {
			showPollutantDialog(graphPollutantCodeNames);
		}

		function showExplanatoryDialog(sHtml, sTitle, sKey) {

			$("#ExplanatoryDialogDiv").html(sHtml);

			theWidthWithUnits = ($(window).width() < 700) ? "98%" : "60%";
			theHeightWithUnits = "auto";

			var explanationPopup = $("#ExplanatoryDialogDiv").dialog({
				autoOpen: true,
				modal: true,
				width: theWidthWithUnits,
				height: theHeightWithUnits,
				classes: {
					"ui-dialog": "explanatoryDialog-ui-dialog"
				},
				closeOnEscape: true,
				draggable: false,
				resizable: false,
				buttons: [{
					text: "Ok",
					click: function() {
						if (sKey !== "") {
							if($("#hidePopup").prop("checked") == true) {
								try {
								localStorage.setItem(sKey, "True");
								} catch (e) {
									console.log("Unable to write to localStorage");
								}
							}
						}
						popupShown= false;
						$(this).dialog("close");
						$(this).dialog("destroy");
					}
				}],
				title: sTitle
			});

			var isIE11 = !!window.MSInputMethodContext && !!document.documentMode;
			if (isIE11) {
				var theMaxHeight = ($(window).width() < 700) ? 0.7 : 0.6;
				theMaxHeight = Math.round(theMaxHeight * $(window).height());
				$('#ExplanatoryDialogDiv').css({
					'max-height': theMaxHeight + "px"
				});
			}
		}

		function showPollutantDialog(pollCodeNames) {
			var sHtml = "<div>";
			$.each(pollCodeNames, function(i, nextCodeName) {
				var nextPollObject = getPollutantObject(nextCodeName);
				sHtml = sHtml + nextPollObject.explanationHtml;
			});

			sHtml = sHtml + "</div>";
			var sTitle = "Pollutants";
			showExplanatoryDialog(sHtml, sTitle,"");
		}

		

		function resizePodDialog() {
			/* leave a gap (roughly even on all sides) and bigger on "desktop" (larger) devices */
			var theMargin, theDelta;
			if ($(window).width() < 700) {
				theMargin = 2;
				theDelta = 12;
			} else {
				theMargin = 5;
				theDelta = 18;
			}

			/* hard-coded class of the jQueryUI element */
			$('.ui-dialog').css({
				'width': ($(window).width() - theDelta) + "px",
				'height': ($(window).height() - theDelta) + "px",
				'left': theMargin + 'px',
				'top': theMargin + 'px'
			});
			/* have to resize tab control contents too */
			$("#graphTabContents").height($("#podDialogTabs").height() - $(".ui-tabs-nav").outerHeight() - theDelta);
		}

		function doesSiteMeasurePollutant(site, pollCodeName) {
			//sites have properties named after the pollutants
			pollAPI = site.feature.properties[pollCodeName];
			if (typeof pollAPI === "undefined") {
				return false;
			} else {
				return true;
			}
		}

		var graphSite;
		var firstPlot;
		var podDialogIsOpen = false;
		// TODO duplication between list of code names for graph dropdown and the one for the popup table
		// This list controls order of graph dropdown (alphabetical)
		//var graphPollutantCodeNames=["CO2", "NO", "NO2", "NOX", "O3", "PM2_5", "PM10"]; 
		var graphPollutantCodeNames = ["NO2", "PM2_5"];
		/* Called when user clicks 'view historical data' button */


		function showData(currentID, historical, locationEnd) {

			var currentSite = sites.find(function(e) {

				if (historical) {

					return ((e.feature.properties.UniqueID === currentID) && (e.feature.properties.LocationEndDate == locationEnd));
				} else {
					return ((e.feature.properties.UniqueID === currentID) && (e.feature.properties.LocationEndDate === undefined));
				}
			});


			dateFrom = new Date(currentSite.feature.properties.LocationStartDate);
			dateFrom.setHours(0, 0, 0, 0);
			if (typeof currentSite === 'undefined') {
				throw "Unrecognised site ID " + currentID;
			}

			// Add a new entry to the browser's history, so if the back button is pressed while the dialog is open it will go back to the map
			window.history.pushState(null, '', '');

			var defaultPollutant = currentMapPollCodeName;
			if (!doesSiteMeasurePollutant(currentSite, defaultPollutant)) {
				defaultPollutant = "NO2";
			}
			var defaultDateTo = new Date(); // today

			if (currentSite.feature.properties.LocationEndDate !== undefined) {
				defaultDateTo = new Date(currentSite.feature.properties.LocationEndDate);
			}


			var network = networkCaptionFromCode(currentSite.feature.properties.Network);

			/* make the popup dialog */
			var thegraphPopupDialog = $("#podDialogDiv").dialog({
				autoOpen: false,
				modal: true,
				width: 'auto',
				closeOnEscape: false,
				draggable: false,
				resizable: false,
				buttons: {},
				title: 'View data - ' + network,
				classes: {
					"ui-dialog-titlebar": "noTitleBar",
					"ui-dialog": "allowFlex"
				}
			});

			$("#podDialogDiv").parent().prependTo("#map div:first");

			/* Sensor name and borough */
			var sSensorNameAndBorough = currentSite.feature.properties.Name;
			if (typeof currentSite.feature.properties.Borough !== 'undefined') {
				sSensorNameAndBorough = sSensorNameAndBorough + ", " + currentSite.feature.properties.Borough;
			}
			$('#graphSensorName').html(currentSite.feature.properties.Name + ".&nbsp;");
			$('#graphSensorNameTR').html(currentSite.feature.properties.Name);
			$('#tableHeader').html("Current values (" + formattedMeasuredAtTime() + ")");
			$('#tableFooter').html("Hourly averages for " + formattedMeasuredAt() + " for " + sSensorNameAndBorough + ".");
			/* setup pollutant select drop-down */
			$('#graphPollSelect').empty();

			$.each(graphPollutantCodeNames, function(i, nextCodeName) {

				if (doesSiteMeasurePollutant(currentSite, nextCodeName)) {

					$('#graphPollSelect').append($('<option>', {
						value: nextCodeName,
						text: getPollutantObject(nextCodeName).shortName,
						selected: (nextCodeName === defaultPollutant)
					}));
				}
			});
			$('#graphPollSelect').on('change', onSettingsChanged);
			/* setup date-pickers */
			var theMinDate = dateFrom; //new Date(2018, 08, 1);  /* 1 sep 2018 because all pods were deployed 31 oct 2018 */
			var theMaxDate = defaultDateTo; //new Date(); /* today */

			/* We've had issues where the datepicker has used the previous min and max dates, or has defaulted to the wrong date format
			This is an issue with the control, the workaround was taken from
			https://stackoverflow.com/questions/35240357/jquery-ui-datepicker-setdate-not-working-on-dynamic-change-of-formatdate  
			it messes the date when you change the dateFormat and you have minDate and maxDate set at the same time.
			We now initialise the datepicker with no options, remove the min and max dates (just in case), set the date format
			, then set the min and max dates (and a default date) before setting the date */

			$("#dateFrom").datepicker();
			$("#dateFrom").datepicker("option", "minDate", null);
			$("#dateFrom").datepicker("option", "maxDate", null);
			$("#dateFrom").datepicker("option", "dateFormat", "d-M-yy");
			$("#dateFrom").datepicker("option", "minDate", theMinDate);
			$("#dateFrom").datepicker("option", "maxDate", theMaxDate);
			$("#dateFrom").datepicker("option", "defaultDate", dateFrom);
			$("#dateFrom").datepicker('setDate', dateFrom);
			$("#dateFrom").datepicker('disable'); /* datepicker workaround to stop calendars and keyboards appearing when not wanted */
			$('#dateFrom').change(function() {
				onSettingsChanged();
			});
			$("#dateTo").datepicker();
			$("#dateTo").datepicker("option", "minDate", null);
			$("#dateTo").datepicker("option", "maxDate", null);
			$("#dateTo").datepicker("option", "dateFormat", "d-M-yy");
			$("#dateTo").datepicker("option", "minDate", theMinDate);
			$("#dateTo").datepicker("option", "maxDate", theMaxDate);
			$("#dateTo").datepicker("option", "defaultDate", defaultDateTo);
			$("#dateTo").datepicker('setDate', defaultDateTo);
			$("#dateTo").datepicker('disable');

			$('#dateTo').change(function() {
				onSettingsChanged();
			});

			$('#graphPollSelect').prop('disabled', true);
			/* show dialog */
			firstPlot = true;
			if (!!window.MSInputMethodContext && !!document.documentMode) {
				exitFullScreen(); // The close button on the graph dialog when fullscreen in IE11
			}
			podDialogIsOpen = true;
			$('#podDialogDiv').dialog("open");

			/* make the tabs control */
			$("#podDialogTabs").tabs({
				active: 0
			});
			resizePodDialog();
			/* show the graph */
			graphSite = currentSite;
			doPlot(defaultPollutant, dateFrom, defaultDateTo, "graphLargeDiv");
		}



		function onSettingsChanged() {
			$("#Refresh").attr("src", "./icons/RefreshPink.png");
			$("#Refresh").attr("onmouseover", "this.src='./icons/RefreshHoverPink.png'");
			$("#Refresh").attr("onmouseout", "this.src='./icons/RefreshPink.png'");
		}

		function doPlotLine(pollutantCodeName, dateFrom, dateTo, displayGraphDiv) {
			var pollutantObject = getPollutantObject(pollutantCodeName);

			// wait cursor 
			var theSpinner = new Spinner({
				scale: 2
			});
			var spinnerContainer = $("#graphTabContents");
			spinnerContainer.after(theSpinner.spin().el);



			var gmtTimeFrom = dateTimeToGMT($.datepicker.formatDate("yy-mm-dd", dateFrom), "01");
			var gmtTimeTo = dateTimeToGMT($.datepicker.formatDate("yy-mm-dd", dateTo), "24");


			Plotly.d3.json(url,
				function(err, jsonData) {
					/* stop the wait cursor */
					theSpinner.stop();
					/* use a closure to pass the pollutant into onJSONDataForGraph */
					onJSONDataForGraphLine(err, jsonData, pollutantObject, displayGraphDiv);
				});
		}

		function onJSONDataForGraphLine(err, jsonData, pollutantObject, graphID) {

			/* jsonData is undefined if the API fails */
			var dataFound = true;
			var showGuidelines = true;
			/* datepicker workaround to stop calendars and keyboards appearing when not wanted */
			$("#dateFrom").datepicker('enable');
			$("#dateTo").datepicker('enable');
			$('#graphPollSelect').prop('disabled', false);
			$("#ui-datepicker-div").prependTo("#map div:first");
			/* On smaller devices graph may be out of view - scroll it back into view. 
			 * Does not work well on all browsers so only do it for small window */
			if ((!firstPlot) && ($(window).width() < 700)) {
				$('#graphPollutantTitle')[0].scrollIntoView(false);
			} else {
				firstPlot = false;
			}

			/* Set the pollutant title to the long name of the poll */
			$("#graphPollutantTitle").html(pollutantObject.longName);



			var theMode;
			var lineColour;
			if (graphID == "graphSmallDiv") {
				theMode = (pollutantObject.average === "daily" ? "lines+markers" : "lines+markers");
				lineColour = '#bbbbbb';
			} else {
				theMode = (pollutantObject.average === "daily" ? "lines+markers" : "lines");
				lineColour = '#007FFF';
			}

			pollDataset = {
				type: "scatter",
				mode: theMode,
				name: pollutantObject.shortName,
				line: {
					color: lineColour,
					width: 1
				},
				/* same colour as active tab background */
				marker: {
					size: 8,
					color: 'rgba(254, 254, 49, 1.0)',
					line: {
						color: '#bbbbbb',
						width: 0.5
					}
				}

			};
			var data;
			var minDate;
			var maxDate;
			if (dataFound) {
				pollDataset.x = no2time_arr;

				pollDataset.y = no2mean_arr;
				/* replace any invalid values with null */
				pollDataset.y = pollDataset.y.map(
					function invalidToNull(currentValue) {
						if (currentValue === -999) {
							return null;
						} else {

							return currentValue;
						}
					}
				);

				pollDataset.marker.line.width = 1;

				pollDataset.marker.color = pollDataset.y.map(function(level) {
					var markerColour;
					markerColour = colourFromNO2Value(level);

					return markerColour;
				});


				pollDataset.marker.line.color = pollDataset.y.map(function(level) {
					var markerColour;
					markerColour = "#888888";
					markerColour = colourFromNO2Value(level);

					return markerColour;
				});

				dataFound = (pollDataset.x.length !== 0); // is there any data at all matching the user's request?
				minDate = pollDataset.x[0];
				maxDate = pollDataset.x[pollDataset.x.length - 1];
			}

			data = [pollDataset];
			var theXAxis;

			if (graphID == "graphSmallDiv") {
				showGuidelines = false;
				theXAxis = {
					showline: true,
					zeroline: false,
					fixedrange: true, //disable panning & zooming
					tickformat: "%H:00",
					dtick: "21600000",
					tickfont: {
						family: 'Courier New, monospace',
						size: 8
					},
					title: {
						//text: '<b>Timeframe (' + pollutantObject.averageName + ')</b>'
					}
				};
				theXAxis.hoverformat = "";
				layout2 = {
					autosize: true,
					hovermode: !1,
					xaxis: theXAxis,
					yaxis: {
						showline: true,
						zeroline: false,
						fixedrange: true, //disable panning & zooming
						tickfont: {
							family: 'Courier New, monospace',
							size: 8
						},
						title: {

						}
					},
					margin: {
						l: 30,
						r: 50,
						b: 30,
						t: 5,
						pad: 4
					},
					width: $("#graphSmallDiv").width(),
					height: $("#graphSmallDiv").height(),
					showlegend: false,
					annotations: []
				};
			} else {
				theXAxis = {
					showline: true,
					zeroline: false,
					fixedrange: true, //disable panning & zooming
					title: {
						text: '<b>Timeframe (' + pollutantObject.averageName + ')</b>'
					}
				};
				if (pollutantObject.average === "hourly") {
					theXAxis.hoverformat = "%b %d, %Y, %H:%M";
				} else { // daily
					// daily average data point x values are at 12 noon to align them with x-axis ticks, but we don't want 12:00 in the data hover tooltips
					theXAxis.hoverformat = "%b %d, %Y";
				}
				layout2 = {
					autosize: true,
					xaxis: theXAxis,
					yaxis: {
						showline: true,
						zeroline: false,
						fixedrange: true, //disable panning & zooming

						title: {
							text: '<b>' + pollutantObject.shortName + ' ' + pollutantObject.units + '</b>',
						}
					},
					margin: {
						l: 50,
						r: 50,
						b: 75,
						t: 10,
						pad: 4
					},
					width: $("#graphLargeDiv").width(),
					height: $("#graphLargeDiv").height(),
					showlegend: false,
					annotations: []
				};
			}

			if (pollutantObject.hasGuidelines && dataFound && showGuidelines) {
				pollutantObject.guidelines.forEach(function(guideline) {
					var lineDash = (guideline.average === pollutantObject.average ? 'solid' : 'dot');
					var theColour = (guideline.average === pollutantObject.average ? guideline.colour : '#696969');
					var guidelineDataset = {
						type: "scatter",
						mode: "lines",
						name: guideline.name,
						x: [minDate, maxDate],
						y: [guideline.value, guideline.value],
						line: {
							color: theColour,
							width: 1,
							dash: lineDash
						},
						hoverinfo: "none"
					};
					data.push(guidelineDataset);
					var guidelineName = ($(window).width() < 700) ? guideline.shortName : guideline.name;
					var guidelineAnnotation = {
						xref: 'paper',
						x: 0.0,
						y: guideline.value,
						xanchor: 'left',
						yanchor: 'top',
						text: guidelineName + ' (<span text-decoration="underline">what\'s this?</span>)', // this span becomes a tspan which is styled as underlined
						showarrow: false,
						captureevents: true,
						pollutantForClick: pollutantObject, // not a PlotLY thing, for use in click handler
						guidelineForClick: guideline, // not a PlotLY thing, for use in click handler
						font: {
							size: 14,
							color: theColour
						}
					};
					layout2.annotations.push(guidelineAnnotation);
				});
			}

			if (!dataFound) {
				$("#disclaimerWHO").html("No data found.");
			} else {
				var sSensorNameAndBoroughHtml = graphSite.feature.properties.Name;
				if (typeof graphSite.feature.properties.Borough !== 'undefined') {
					sSensorNameAndBoroughHtml = sSensorNameAndBoroughHtml + ", " + graphSite.feature.properties.Borough;
				}
				var disclaimerWHOHtml = "The graph shows " + pollutantObject.average +
					" average concentrations of " + pollutantObject.shortName + " at " + sSensorNameAndBoroughHtml + ".";
				if (pollutantObject.hasGuidelines) {
					disclaimerWHOHtml = disclaimerWHOHtml + ' Also displayed are the World Health Organization\'s <a href="http://www.euro.who.int/__data/assets/pdf_file/0019/331660/Evolution-air-quality.pdf?ua=1" target="_blank"  rel="noopener">Air Quality Guidelines</a> for ' + pollutantObject.shortName + '; evidence-based targets for air quality management to protect populations from the adverse health effects of air pollution.';
				}
				$("#disclaimerWHO").html(disclaimerWHOHtml);
			}

			if (!dataFound) {
				/* no data at all - tell the user */
				var noDataAnnotation = {
					xref: 'paper',
					x: 0.5,
					yref: 'paper',
					y: 0.5,
					xanchor: 'center',
					yanchor: 'center',
					text: "No data found",
					showarrow: false,
					font: {
						size: 28,
						color: BreatheLondonPinkColour
					}
				};
				layout2.annotations.push(noDataAnnotation);
			}

			// On a touch device with small screen, user needs to pan by tapping and dragging
			var disableInteraction = isTouchDevice() && ($(window).height() < 700);

			var config = {
				responsive: false,
				showSendToCloud: false,
				displayModeBar: false,
				staticPlot: disableInteraction
			};


			Plotly.newPlot(graphID, data, layout2, config).then(function(gd) {
				gd.on('plotly_clickannotation', function(e) {
					guidelineClicked(e);
				});
			});
		}


		function doPlot(pollutantCodeName, dateFrom, dateTo, displayGraphDiv, IsAQMesh) {

			if (IsAQMesh === undefined) {
				IsAQMesh = true;
			}

			var pollutantObject = getPollutantObject(pollutantCodeName);

			// wait cursor 
			var theSpinner = new Spinner({
				scale: 2
			});
			var spinnerContainer = $("#graphTabContents");
			spinnerContainer.after(theSpinner.spin().el);

			//use global for station ID
			var url;

			if (currentMapPollCodeName == "NOx") {
				if (IsAQMesh) {
					url = "https://breathelondon.net/map/data/latestAQMesh12.json";
				} else {
					url = "https://breathelondon.net/map/data/latestLAQNandAQE5.json";
				}
			} else {
				
				url = graphAQMeshDataURL + "?station=C40_" +
					graphSite.feature.properties.UniqueID + "&sensor=" + pollutantObject.codeName;

				if ((pollutantObject.average === "daily") && (displayGraphDiv != "graphSmallDiv")) {
					url = url + "&avg=daily";
				}

				if (displayGraphDiv == "graphSmallDiv") {
					var defaultDateTo = setDateStringAsGMT(aqmeshData.MeasuredDate); //new Date(2019,10,08,17,00,00);  //setDateStringAsGMT(aqmeshData.MeasuredDate);
					var defaultDateFrom = new Date(defaultDateTo - 86400 * 1000);

					url = url +
						"&from=" + formatGMTTime(defaultDateFrom, "YYYYMMDD-HHmm") +
						"&to=" + formatGMTTime(defaultDateTo, "YYYYMMDD-HHmm");
				} else {
					var gmtTimeFrom = dateTimeToGMT($.datepicker.formatDate("yy-mm-dd", dateFrom), "01");
					var gmtTimeTo = dateTimeToGMT($.datepicker.formatDate("yy-mm-dd", dateTo), "24");
					url = url +
						//The dates passed should be converted to GMT (if required)

						"&from=" + gmtTimeFrom +
						"&to=" + gmtTimeTo;

				}
			}

			Plotly.d3.json(url,
				function(err, jsonData) {
					/* stop the wait cursor */
					theSpinner.stop();
					/* use a closure to pass the pollutant into onJSONDataForGraph */
					onJSONDataForGraph(err, jsonData, pollutantObject, displayGraphDiv);
				});
		}

		function formatGMTTime(dateGMT, dateFormat) {
			moment.tz.setDefault("UTC");
			return moment(dateGMT).tz('UTC').format(dateFormat);
		}

		function setDateStringAsGMT(inputDateString) {
			moment.tz.setDefault("UTC");
			return moment(inputDateString, "YYYY-MM-DDTHH:mm:ss").tz('UTC').toDate();
		}

		function dateTimeToGMT(date, hour) {
			var a = moment.tz(date + "T" + hour, 'Europe/London');
			return a.utc().format("YYYYMMDD-HHmm");
		}

		function GMTtoUKTimeFormat(dateGMT, dateFormat) {
			moment.tz.setDefault("UTC");
			return moment(dateGMT).tz('Europe/London').format(dateFormat);
		}

		function localTimeString(dateGMT) {
			return GMTtoUKTimeFormat(dateGMT, 'HH:mm');
		}


		/* Called when user clicks Draw button on the graph pop up */
		function downloadClicked() {
			//alert("The download feature is not available yet.");
			var hiddenElement = document.createElement('a');
			hiddenElement.href = '/download/AQMesh_Scaled_Dataset_UGM3.csv';
			hiddenElement.target = '_blank';
			hiddenElement.download = 'Scaled_Dataset_UGM3.csv';
			hiddenElement.click();
		}

		/* Called when user clicks Draw button on the graph pop up */
		function drawClicked() {
			var dateFromVal = $("#dateFrom").datepicker("getDate");
			var dateToVal = $("#dateTo").datepicker("getDate");
			var pollutantVal = $("#graphPollSelect").val();
			doPlot(pollutantVal, dateFromVal, dateToVal, "graphLargeDiv");
			$("#Refresh").attr("src", "./icons/RefreshGrey.png");
			$("#Refresh").attr("onmouseover", "this.src='./icons/RefreshHoverGrey.png'");
			$("#Refresh").attr("onmouseout", "this.src='./icons/RefreshGrey.png'");
		}

		/* Called when user clicks close button on the graph pop up */
		function closeClicked() {
			closePodDialog(true);
		}

		function closePodDialog(removehistory) {
			if (podDialogIsOpen) {
				$('#podDialogDiv').dialog("close");
				podDialogIsOpen = false;
			}
		}


		/* Called when BreatheLondon API returns data and graph can be plotted */
		function onJSONDataForGraph(err, jsonData, pollutantObject, graphID) {
			/* jsonData is undefined if the API fails */
			var dataFound;
			var theMode;
			/* datepicker workaround to stop calendars and keyboards appearing when not wanted */
			$("#dateFrom").datepicker('enable');
			$("#dateTo").datepicker('enable');
			$('#graphPollSelect').prop('disabled', false);
			$("#ui-datepicker-div").prependTo("#map div:first");
			/* On smaller devices graph may be out of view - scroll it back into view. 
			 * Does not work well on all browsers so only do it for small window */
			if ((!firstPlot) && ($(window).width() < 700)) {
				$('#graphPollutantTitle')[0].scrollIntoView(false);
			} else {
				firstPlot = false;
			}

			/* Set the pollutant title to the long name of the poll */
			$("#graphPollutantTitle").html(pollutantObject.longName);
			var lineColour;
			if (graphID == "graphSmallDiv") {
				theMode = (pollutantObject.average === "daily" ? "lines+markers" : "lines+markers");
				lineColour = '#bbbbbb';
			} else {
				theMode = (pollutantObject.average === "daily" ? "lines" : "lines");
				lineColour = '#007FFF';
			}
			var showGuidelines = true;
			var showLine = true;
			var thePollutantCode = $("input[name='pollutantRadios']:checked").val();
			var showXTicks = true;
			var tickYAxisLabelSuffix = "";

			if (thePollutantCode == "NOx") {
				dataFound = false;
				showXTicks = false;
				showAxisLine = false;
				axisType = 'category';
				axisFontFamily = 'Lato,sans-serif';
				axisFontSize = 12;
				axisTickFormat = "%s";
				axisDTick = "";
				tickYAxisLabelSuffix ="%";
				hoverMode = 'closest';
				yRange = [-20, 125];
				graphResponsive = true;
				iconImages2[0].y = -20; 
				iconImages2[1].y = -20; 
				iconImages2[2].y = -20;
				iconImages2[3].y = -20;
				iconImages2[4].y = -20;
				iconImages = [{
						"source": categoryLookup[0].imgUnselected,
						"xref": "x",
						"yref": "y",
						"x": 0,
						"y": getCategoryPercentage(categoryLookup[0].codeName) + 5,
						"sizex": 1,
						"sizey": 15,
						"xanchor": "center",
						"yanchor": "bottom"
					},
					{
						"source": categoryLookup[1].imgUnselected,
						"xref": "x",
						"yref": "y",
						"x": 1,
						"y": getCategoryPercentage(categoryLookup[1].codeName) + 5,
						"sizex": 1,
						"sizey": 15,
						"xanchor": "center",
						"yanchor": "top"
					},
					{
						"source": categoryLookup[2].imgUnselected,
						"xref": "x",
						"yref": "y",
						"x": 2,
						"y": getCategoryPercentage(categoryLookup[2].codeName) + 5,
						"sizex": 1,
						"sizey": 15,
						"xanchor": "center",
						"yanchor": "bottom"
					},
					{
						"source": categoryLookup[3].imgUnselected,
						"xref": "x",
						"yref": "y",
						"x": 3,
						"y": getCategoryPercentage(categoryLookup[3].codeName) + 5,
						"sizex": 1,
						"sizey": 15,
						"opacity": 1,
						"xanchor": "center",
						"yanchor": "bottom"
					},
					{
						"source": categoryLookup[4].imgUnselected,
						"xref": "x",
						"yref": "y",
						"x": 4,
						"y": getCategoryPercentage(categoryLookup[4].codeName) + 5,
						"sizex": 1,
						"sizey": 15,
						"opacity": 1,
						"xanchor": "center",
						"yanchor": "bottom"
					},
				];
				
				
			var barDisplayValues=[getCategoryPercentage(categoryLookup[0].codeName).toFixed(0) + '%',
						getCategoryPercentage(categoryLookup[1].codeName).toFixed(0) + '%',
						' ' + getCategoryPercentage(categoryLookup[2].codeName).toFixed(0) + '%',
						getCategoryPercentage(categoryLookup[3].codeName).toFixed(0) + '%.',
						' ' + getCategoryPercentage(categoryLookup[4].codeName).toFixed(0) + '% '
					];
				pollDataset = 
				{
					x: barDisplayValues,
					y: [getCategoryPercentage(categoryLookup[0].codeName),
						getCategoryPercentage(categoryLookup[1].codeName),
						getCategoryPercentage(categoryLookup[2].codeName),
						getCategoryPercentage(categoryLookup[3].codeName),
						getCategoryPercentage(categoryLookup[4].codeName)
					],
					type: 'bar',
					text: barDisplayValues.map(String),
					textposition: "outside",
					textfont: {
						family: 'Lato,sans-serif',
						size: 12,
						color: '#adadad;'
					},
					hoverinfo: "none",
					marker: {
						color: bargraphcolours,
						line: {
							color: BreatheLondonPinkColour,
							width: 0
						}
					}
				};
			} else {
				dataFound = (typeof jsonData !== 'undefined');
				showAxisLine = true;
				axisType = '-';
				axisFontFamily = 'Courier New, monospace';
				axisFontSize = 8;
				axisTickFormat = "%H:00";
				axisDTick = "21600000";
				hoverMode = !1;
				yRange = [0, 40];
				graphResponsive = false;
				iconImages = [];
				pollDataset = {
					type: "scatter",
					mode: theMode,
					name: pollutantObject.shortName,
					line: {
						color: lineColour,
						width: 1
					},
					/* same colour as active tab background */
					marker: {
						size: 8,
						color: 'rgba(254, 254, 49, 1.0)',
						line: {
							color: '#bbbbbb',
							width: 0.5
						}
					}

				};
			}
			/* datepicker workaround to stop calendars and keyboards appearing when not wanted */
			$("#dateFrom").datepicker('enable');
			$("#dateTo").datepicker('enable');
			$('#graphPollSelect').prop('disabled', false);
			$("#ui-datepicker-div").prependTo("#map div:first");
			/* On smaller devices graph may be out of view - scroll it back into view. 
			 * Does not work well on all browsers so only do it for small window */
			if ((!firstPlot) && ($(window).width() < 700)) {
				$('#graphPollutantTitle')[0].scrollIntoView(false);
			} else {
				firstPlot = false;
			}

			/* Set the pollutant title to the long name of the poll */
			$("#graphPollutantTitle").html(pollutantObject.longName);




			var data;
			var minDate;
			var maxDate;
			if (dataFound) {
				pollDataset.x = unpackdate(jsonData.GraphValues, 'DateTime');
				pollDataset.y = unpack(jsonData.GraphValues, 'Level');
				/* replace any invalid values with null */
				pollDataset.y = pollDataset.y.map(
					function invalidToNull(currentValue) {
						if (currentValue === -999) {
							return null;
						} else {

							return currentValue;
						}
					}
				);

				pollDataset.marker.line.width = 1;

				pollDataset.marker.color = pollDataset.y.map(function(level) {
					var markerColour;
					if (pollutantObject.shortName == "NO2") {
						markerColour = colourFromNO2Value(level);
					} else {
						markerColour = colourFromPM25Value(level);
					}
					return markerColour;
				});


				pollDataset.marker.line.color = pollDataset.y.map(function(level) {
					var markerColour;
					markerColour = "#888888";
					return markerColour;
				});

				dataFound = (pollDataset.x.length !== 0); // is there any data at all matching the user's request?
				minDate = pollDataset.x[0];
				maxDate = pollDataset.x[pollDataset.x.length - 1];
			}
			if (thePollutantCode == "NOx") {
				// To enable clicking event for the icons, we're putting a white stacked bar under the icons
				categoryGraphBlankStackDown = {
					x: barDisplayValues,
					y: [-20.0, -20.0, -20.0, -20.0, -20.0],
					type: 'bar',
					textfont: "none",
					hoverinfo: "none",
					marker: {
						color: 'white',
						line: {
							width: 0
						}
					}
				};
				categoryGraphBlankStackUp = {
					x: barDisplayValues,
					y: [20.0, 20.0, 20.0, 20.0, 20.0],
					type: 'bar',
					textfont: "none",
					hoverinfo: "none",
					marker: {
						color: 'white',
						line: {
							width: 0
						}
					}
				};
				data =[categoryGraphBlankStackDown, categoryGraphBlankStackUp, pollDataset];
				
			} else {
				data = [pollDataset];
			}
			var theXAxis;

			if (graphID == "graphSmallDiv") {
				showGuidelines = false;

				theXAxis = {
					showline: showAxisLine,
					type: axisType,
					zeroline: false,
					fixedrange: true, //disable panning & zooming
					tickformat: axisTickFormat,
					showticklabels: showXTicks,
					dtick: axisDTick,
					tickfont: {
						family: axisFontFamily,
						size: axisFontSize
					}
				};
				theXAxis.hoverformat = "";

				layout2 = {
					hovermode: hoverMode,
					barmode: 'stack',
					xaxis: theXAxis,
					yaxis: {
						visible: true,
						range: yRange,
						showline: false,
						zeroline: false,
						fixedrange: true, //disable panning & zooming
						tickfont: {
							family: 'Courier New, monospace',
							size: 10,
							color: "#dadada;"
						},
						showticksuffix: 'all',
						ticksuffix: tickYAxisLabelSuffix,
						title: {

						}
					},
					margin: {
						l: 30,
						r: 50,
						b: 30,
						t: 5,
						pad: 4
					},
					width: $("#graphSmallDiv").width(),
					height: $("#graphSmallDiv").height(),
					showlegend: false,
					annotations: [],
					images: iconImages2
				};
				if (thePollutantCode !== "NOx") {
					delete layout2.yaxis['range'];
				}
			} else {
				theXAxis = {
					showline: true,
					zeroline: false,
					fixedrange: true, //disable panning & zooming
					title: {
						text: '<b>Timeframe (' + pollutantObject.averageName + ')</b>'
					}
				};
				if (pollutantObject.average === "hourly") {
					theXAxis.hoverformat = "%b %d, %Y, %H:%M";
				} else { // daily
					// daily average data point x values are at 12 noon to align them with x-axis ticks, but we don't want 12:00 in the data hover tooltips
					theXAxis.hoverformat = "%b %d, %Y";
				}
				layout2 = {
					xaxis: theXAxis,
					yaxis: {
						showline: true,
						zeroline: false,
						fixedrange: true, //disable panning & zooming

						title: {
							text: '<b>' + pollutantObject.shortName + ' ' + pollutantObject.units + '</b>',
						}
					},
					margin: {
						l: 50,
						r: 50,
						b: 75,
						t: 10,
						pad: 4
					},
					width: $("#graphLargeDiv").width(),
					height: $("#graphLargeDiv").height(),
					showlegend: false,
					annotations: []
				};
			}

			if (pollutantObject.hasGuidelines && dataFound && showGuidelines) {
				pollutantObject.guidelines.forEach(function(guideline) {
					var lineDash = (guideline.average === pollutantObject.average ? 'solid' : 'dot');
					var theColour = (guideline.average === pollutantObject.average ? guideline.colour : '#696969');
					var guidelineDataset = {
						type: "scatter",
						mode: "lines",
						name: guideline.name,
						x: [minDate, maxDate],
						y: [guideline.value, guideline.value],
						line: {
							color: theColour,
							width: 1,
							dash: lineDash
						},
						hoverinfo: "none"
					};
					data.push(guidelineDataset);
					var guidelineName = ($(window).width() < 700) ? guideline.shortName : guideline.name;
					var guidelineAnnotation = {
						xref: 'paper',
						x: 0.0,
						y: guideline.value,
						xanchor: 'left',
						yanchor: 'top',
						text: guidelineName + ' (<span text-decoration="underline">what\'s this?</span>)', // this span becomes a tspan which is styled as underlined
						showarrow: false,
						captureevents: true,
						pollutantForClick: pollutantObject, // not a PlotLY thing, for use in click handler
						guidelineForClick: guideline, // not a PlotLY thing, for use in click handler
						font: {
							size: 14,
							color: theColour
						}
					};
					layout2.annotations.push(guidelineAnnotation);
				});
			}

			if (!dataFound) {
				$("#disclaimerWHO").html("No data found.");
			} else {
				var sSensorNameAndBoroughHtml = graphSite.feature.properties.Name;
				if (typeof graphSite.feature.properties.Borough !== 'undefined') {
					sSensorNameAndBoroughHtml = sSensorNameAndBoroughHtml + ", " + graphSite.feature.properties.Borough;
				}
				var disclaimerWHOHtml = "The graph shows " + pollutantObject.average +
					" average concentrations of " + pollutantObject.shortName + " at " + sSensorNameAndBoroughHtml + ".";
				if (pollutantObject.hasGuidelines) {
					disclaimerWHOHtml = disclaimerWHOHtml + ' Also displayed are the World Health Organization\'s <a href="http://www.euro.who.int/__data/assets/pdf_file/0019/331660/Evolution-air-quality.pdf?ua=1" target="_blank"  rel="noopener">Air Quality Guidelines</a> for ' + pollutantObject.shortName + '; evidence-based targets for air quality management to protect populations from the adverse health effects of air pollution.';
				}
				$("#disclaimerWHO").html(disclaimerWHOHtml);
			}

			if ((!dataFound) && false) {
				/* no data at all - tell the user */
				var noDataAnnotation = {
					xref: 'paper',
					x: 0.5,
					yref: 'paper',
					y: 0.5,
					xanchor: 'center',
					yanchor: 'center',
					text: "No data found",
					showarrow: false,
					font: {
						size: 28,
						color: BreatheLondonPinkColour
					}
				};
				layout2.annotations.push(noDataAnnotation);
			}

			// On a touch device with small screen, user needs to pan by tapping and dragging
			var disableInteraction = isTouchDevice() && ($(window).height() < 700);

			var config = {
				responsive: graphResponsive,
				showSendToCloud: false,
				displayModeBar: false,
				staticPlot: disableInteraction
			};

			if (thePollutantCode == "NOx") {
				var myPlot = document.getElementById(graphID),
					d3 = Plotly.d3,
					N = 16,
					x = d3.range(N),
					y = d3.range(N).map(d3.random.normal()),
					data = data,
					layout = layout2;

				Plotly.newPlot(myPlot, data, layout2, config);

				fillSourceTable();
				myPlot.on('plotly_click', function(data) {
					var pts = '';
					for (var i = 0; i < data.points.length; i++) {
						pts = data.points[i].pointNumber;
					}
					updateCategories(pts, true);

				});

			} else {
				Plotly.newPlot(graphID, data, layout2, config).then(function(gd) {
					gd.on('plotly_clickannotation', function(e) {
						guidelineClicked(e);
					});
				});
			}
		}

		function guidelineClicked(e) {
			var sHtml = "<div>" + e.annotation.guidelineForClick.explanationHtml + "<br/></div>";
			var sTitle = "WHO guideline";
			showExplanatoryDialog(sHtml, sTitle,"");
		}

		/* Extract a property (key) from every object in the JSON and return as array */
		function unpack(rows, key) {
			return rows.map(function(row) {
				return row[key];
			});
		}

		function unpackdate(rows, key) {
			return rows.map(function(row) {
				//row[key] is in the form "2019-07-10 15:00"
				//ie doesn't like the format
				var datestring = row[key];
				//Plotly always uses local time, so to force it to use UK time, we're going to have to manually offset the datetime
				inputDate = moment(datestring, "YYYY-MM-DD HH:mm");
				offset = inputDate.tz('Europe/London').utcOffset() - inputDate.local().utcOffset();
				return inputDate.add(offset, 'minutes').toDate();
			});
		}


		function updateCategories(index, fromGraph) {

			if (index == 0) {
				bargraphcolours = [BreatheLondonPinkColour, '#dadada', '#dadada', '#dadada', '#dadada'];
			}
			if (index == 1) {
				bargraphcolours = ['#dadada', BreatheLondonPinkColour, '#dadada', '#dadada', '#dadada'];
			}
			if (index == 2) {
				bargraphcolours = ['#dadada', '#dadada', BreatheLondonPinkColour, '#dadada', '#dadada'];
			}
			if (index == 3) {
				bargraphcolours = ['#dadada', '#dadada', '#dadada', BreatheLondonPinkColour, '#dadada'];
			}
			if (index == 4) {
				bargraphcolours = ['#dadada', '#dadada', '#dadada', '#dadada', BreatheLondonPinkColour];
			}
			var update = {
				'marker': {
					color: bargraphcolours,
					line: {
						color: 'rgb(240,3,121)',
						width: 0
					}
				}
			};

			for (var i = 0; i < iconImages2.length; i++) {
				if (i == index) {
					iconImages2[i].source = categoryLookup[i].imgSelected;
				} else {
					iconImages2[i].source = categoryLookup[i].imgUnselected;
				}
			}

			pollDataset.marker.color = bargraphcolours;
			layout2.images = iconImages2;
			var config = {
				responsive: false,
				showSendToCloud: false,
				displayModeBar: false,
				staticPlot: false
			};
			Plotly.react("graphSmallDiv", [categoryGraphBlankStackDown, categoryGraphBlankStackUp, pollDataset], layout2, config);
			if (fromGraph) {
				$('#categories').val(index).change();
			} else {
				currentBar = index;
				fillSourceTable();
			}

		}

		function panelPhoneStyle(panelID, divID, showPanel) {
			if (showPanel) {
				document.getElementById(panelID).style.display = "block";
			} else {
				document.getElementById(panelID).style.display = "none";
			}
			document.getElementById(panelID).style.left = "0";
			document.getElementById(panelID).style.width = "100%";
			document.getElementById(divID).style.marginLeft = "auto";
			document.getElementById(divID).style.marginRight = "auto";
		}

		function panelDesktopStyle(panelID, divID, display, side, width, showPanel) {
			if (showPanel) {
				document.getElementById(panelID).style.display = "block";
			} else {
				document.getElementById(panelID).style.display = "none";
			}
			document.getElementById(panelID).style.width = width;
			if (side === "left") {
				document.getElementById(panelID).style.left = "0";
				document.getElementById(panelID).style.right = "auto";
			} else {
				document.getElementById(panelID).style.right = "0";
				document.getElementById(panelID).style.left = "auto";
			}
			document.getElementById(divID).style.marginLeft = "0px";
			document.getElementById(divID).style.marginRight = "0px";
		}


		function hideShowPanelsAndMapButtons(controlToShow) {
			if (mapLoaded) {
				//Hide any existing panels
				if (useSmallScreen()) {
					//Only need to hide the layers panel when in a small screen - otherwise just leave it as it is
					document.getElementById("layerPanel").style.display = "none";
				}
				document.getElementById("sitePanel").style.display = "none";
				document.getElementById("faqPanel").style.display = "none";
				var layerButton = document.getElementById('layerButtonRow');
				//No panel to display
				if (controlToShow === "") {

					//If there was a selected site then unhighlight the marker and remove the label
					deselectSite();

					//Show the full buttons for this size and browser
					//We are explicitly setting these for full screen, just in case there has been a resize
					if (document.getElementById('zoomButtonRow')) {
						document.getElementById("zoomButtonRow").style.display = "block";
					}
					//The full screen button will not have been created if in IE11 or iPad, so need to check it exists
					if (document.getElementById('fullScreenButtonRow')) {
						document.getElementById("fullScreenButtonRow").style.display = "block";
					}
					if (document.getElementById('faqButtonRow')) {
						document.getElementById("faqButtonRow").style.display = "block";
					}
					if (useSmallScreen()) {
						document.getElementById("phoneHeadingLayers").style.display = "block";
						if (typeof(layerButton) !== 'undefined' && layerButton !== null) {
							layerButton.style.display = "block";
						}
					} else {
						document.getElementById("phoneHeadingLayers").style.display = "none";
						if (typeof(layerButton) !== 'undefined' && layerButton !== null) {
							layerButton.style.display = "none";
						}
					}
				} else {
					//There is a panel
					document.getElementById("phoneHeadingLayers").style.display = "none";
					if (typeof(layerButton) !== 'undefined' && layerButton !== null) {
						layerButton.style.display = "none";
					}
					if (useSmallScreen()) {
						if (document.getElementById('fullScreenButtonRow')) {
							document.getElementById("fullScreenButtonRow").style.display = "none";
						}
						document.getElementById("faqButtonRow").style.display = "none";
						document.getElementById("zoomButtonRow").style.display = "none";
					} else {
						if (document.getElementById('fullScreenButtonRow')) {
							document.getElementById("fullScreenButtonRow").style.display = "block";

						}
						if (controlToShow === "layerPanel") {
							document.getElementById("faqButtonRow").style.display = "block";
						} else {
							document.getElementById("faqButtonRow").style.display = "none";
						}
						document.getElementById("zoomButtonRow").style.display = "block";
					}
					if (controlToShow === "faqPanel") {
						document.getElementById("faqPanel").style.display = "block";
						document.getElementById("faqButtonRow").style.display = "none";

					}
					if (controlToShow === "sitePanel") {
						document.getElementById("faqPanel").style.display = "none";
						document.getElementById("faqButtonRow").style.display = "none";
					}
					document.getElementById(controlToShow).style.display = "block";
					sectionSizer();
				}
			}

		}

		function closeLHS() {

			if (document.getElementById("layerPanel").style.width == "220px") {
				document.getElementById("layerPanel").style.width = "0px";
				document.getElementById("layerPanel").style.padding = "0px";
				document.getElementById("arrowL").src = "./icons/OpenL3.png";
				document.getElementById("arrowL").alt = "Show";


			} else {
				document.getElementById("layerPanel").style.width = "220px";
				document.getElementById("layerPanel").style.padding = "0px 8px 16px 16px";
				document.getElementById("arrowL").src = "./icons/CloseL2.png";
				document.getElementById("arrowL").alt = "Hide";
			}
		}

		function colourFromValue(value) {
			if (currentMapPollCodeName === "NO2") {
				return colourFromNO2Value(value);
			} else {
				return colourFromPM25Value(value);
			}

		}

		function colourFromPM25Value(value) {
			var returnColour;

			if (value > 50) {
				returnColour = newmarkercolours[6];
			} else if (value > 25) {
				returnColour = newmarkercolours[4];
			} else if (value > 10) {
				returnColour = newmarkercolours[3];
			} else if (value > 5) {
				returnColour = newmarkercolours[2];
			} else if (value > 0) {
				returnColour = newmarkercolours[0];
			} else {
				returnColour = "#dadada";
			}
			return returnColour;
		}

		function colourFromNO2Value(value) {
			if (value > 200) {
				return newmarkercolours[6];
			} else if (value > 100) {
				return newmarkercolours[5];
			} else if (value > 60) {
				return newmarkercolours[4];
			} else if (value > 40) {
				return newmarkercolours[3];
			} else if (value > 20) {
				return newmarkercolours[2];
			} else if (value > 10) {
				return newmarkercolours[1];
			} else if (value > 0) {
				return newmarkercolours[0];
			} else {
				return "#dadada";
			}
		}


		function setRoadListener(roadLayer) {
			roadLayer.addListener('click', function(event) {
				selectSite(event, featureType.GOOGLE, false);
			});
		}

		function showRoads() {
			if (document.getElementById("caroption").checked === true) {
				document.getElementById("carimage").src = "icons/Car2.png";
				setDefaultCarStyle(true);
				document.getElementById("carimage").src = "icons/Car.png";
			} else {
				if (carLayer !== null) {
					setDefaultCarStyle(false);
					if (selectedSiteType === featureType.GOOGLE) {
						deselectSite();
					}
				}
			}

		}

		// Disable 'on-roads' checkbox and hide roads from map
		function disableRoads(callShowRoads) {
			showCars = document.getElementById("caroption").checked;
			document.getElementById("caroption").checked = false;
			if (callShowRoads === true) {
				showRoads();
			}
			document.getElementById("carimage").src = "icons/Car2.png";
			document.getElementById("caroption").disabled = true;
			document.getElementById("caroptionlabel").style.borderColor = "#dddddd";
			document.getElementById("caroptionlabel").style.backgroundColor = "#dddddd";
			document.getElementById("caroptiontext").style.color = "#dddddd";
		}
		// Enable 'on-roads' checkbox and show roads on map
		function enableRoads(callShowRoads) {
			document.getElementById("caroption").checked = showCars;
			if (callShowRoads === true) {
				showRoads();
			}
			document.getElementById("carimage").src = "icons/Car.png";
			document.getElementById("caroption").disabled = false;
			document.getElementById("caroptionlabel").style.borderColor = BreatheLondonPinkColour;
			document.getElementById("caroptionlabel").style.backgroundColor = "";
			document.getElementById("caroptiontext").style.color = "#676767";
		}

		function showTimePeriod(timeFor) {

			dataMode = timeFor;
			document.getElementById('graphRHS').style.borderTop = "1px solid #bbb";
			if (timeFor == "current") {
				$("#nowhourtitle2").html("Current air quality");
				document.getElementById("noDataLocations").innerHTML = "No current data";
				document.getElementById('pastlocations').style.display = "";
			} else if (timeFor == "source") {
				if (loadedMode) {
					initialPopup("sources");
				}
				$("#nowhourtitle2").html("NOx pollution sources");
				document.getElementById("noDataLocations").innerHTML = "No sources";
				document.getElementById('pastlocations').style.display = "";
				document.getElementById('graphRHS').style.borderTop = "none";
			} else {
				if (!bRoadLoaded) {
					carLayer = new google.maps.Data();
					carLayer.loadGeoJson('https://breathelondon.net/map/data/central0_drivesummarystats_4Google_20Mar16.geojson');
					startCarSpinner();
					var carCount = 0;
					carLayer.setStyle(function(feature) {
						carCount++;
						
						if (carCount === COUNT_OF_GOOGLE_ROADS) { // HACK hard-coded number of roads
							stopCarSpinner();
							//Now it's OK to click the mobile data
							bRoadLoaded = true;
							//Enable/disable control, no need to set roads visible/invisible again: just done that

							if (currentMapPollCodeName === "NO2") {
								enableRoads(false);
							} else {
								disableRoads(false);
							}
						}
						return {
							visible: false
						};
					});
					setRoadListener(carLayer);
					carLayer.setMap(map);
				}
				$("#nowhourtitle2").html("Average air quality");

				document.getElementById("noDataLocations").innerHTML = "No data";
				document.getElementById('pastlocations').style.display = "none";
			}
			enableDisableLHSControls();
			updateMapAndLegend(currentMapPollCodeName);
			//if Google or is going to average and is not AQmesh
			if ((selectedSiteType === featureType.GOOGLE) || (((selectedSiteType === featureType.AQE) || (selectedSiteType === featureType.LAQN)) && (document.getElementById("average").checked)) || ((selectedSiteType === featureType.FIA) && (document.getElementById("source").checked))) {
				deselectSite();
			} else {
				reselectSite();
				
			}
		}

		function showEmissionZones(zoomToZone) {
			var cbULEZ = document.getElementById("ulez");
			var cbEULEZ = document.getElementById("eulez");
			var cbLEZ = document.getElementById("lez");

			if (cbULEZ.checked === true || cbEULEZ.checked === true || cbLEZ.checked === true) {
				ezLayer.setStyle(function(feature) {
					var SD_NAME = feature.getProperty('Name');
					var color;
					var width;
					if (SD_NAME == "ULEZ") {
						color = "#145A32";
						if (cbULEZ.checked === true) {
							width = 6;
							if (zoomToZone == "ULEZ") {
								var bounds = new google.maps.LatLngBounds();
								feature.getGeometry().forEachLatLng(function(latlng) {
									bounds.extend(latlng);
								});
								map.fitBounds(bounds);
							}
						} else {
							width = 0;
						}
					}
					if (SD_NAME == "LEZ") {
						color = "#A9DFBF";
						if (cbLEZ.checked === true) {
							width = 4;
							if (zoomToZone == "LEZ") {
								var bounds = new google.maps.LatLngBounds();
								feature.getGeometry().forEachLatLng(function(latlng) {
									bounds.extend(latlng);
								});
								map.fitBounds(bounds);
							}
						} else {
							width = 0;
						}
					}
					if (SD_NAME == "Expanded ULEZ") {
						color = "#27AE60";
						if (cbEULEZ.checked === true) {
							width = 5;
							if (zoomToZone == "Expanded ULEZ") {
								var bounds = new google.maps.LatLngBounds();
								feature.getGeometry().forEachLatLng(function(latlng) {
									bounds.extend(latlng);
								});
								map.fitBounds(bounds);
							}
						} else {
							width = 0;
						}
					}
					return {
						strokeColor: color,
						strokeWeight: width
					};
				});
				ezLayer.setMap(map);
			} else {
				ezLayer.setMap(null);
			}
		}

		function SingleButtonRow(controlDiv, id, imagefilename, iconwidth) {
			controlDiv.setAttribute("id", id);

			// Creating divs & styles for custom zoom control
			controlDiv.style.padding = '5px';

			// Set CSS for the control wrapper
			var controlWrapper = document.createElement('div');
			controlWrapper.style.backgroundColor = 'white';
			controlWrapper.style.borderStyle = 'solid';
			controlWrapper.style.borderColor = 'gray';
			controlWrapper.style.borderWidth = '1px';
			controlWrapper.style.cursor = 'pointer';
			controlWrapper.style.textAlign = 'center';
			controlWrapper.style.width = iconwidth;
			controlWrapper.style.height = '30px';
			controlWrapper.style.zIndex = 1;
			controlDiv.appendChild(controlWrapper);

			var button = document.createElement('div');
			button.style.width = iconwidth;
			button.style.height = '30px';
			button.style.float = 'left';
			/* Change this to be the .png image you want to use */
			button.style.backgroundImage = 'url("./' + imagefilename + '")';
			controlWrapper.appendChild(button);

			return button;

		}

		function ShowSearchButton(map, controlPosition) {
			if (searchButtonDiv === null) {
				searchButtonDiv = document.getElementById("searchMapControls");
			}
			map.controls[controlPosition].push(searchButtonDiv);
			searchButtonDiv.index = 1;
			document.getElementById("searchInputTextBox").value = "";
			document.getElementById("searchLocationWarning").innerHTML = "";
			document.getElementById("searchLocationWarning").style.display = 'none';
			searchButtonDiv.style.display = "block";
		}

		function ShowCurrentLocationButtons(map, controlPosition) {
			if (currentLocationButtonDiv === null) {
				currentLocationButtonDiv = document.getElementById("currentLocationMapControls");
			}
			map.controls[controlPosition].push(currentLocationButtonDiv);
			currentLocationButtonDiv.index = 1;
			document.getElementById("currentLocationWarning").innerHTML = "";
			document.getElementById("currentLocationWarning").style.display = 'none';
			currentLocationButtonDiv.style.display = "block";
		}


		function AddLayerButtons(map, controlPosition, show) {
			var buttonsDiv = document.createElement('div');
			var button;
			button = SingleButtonRow(buttonsDiv, "layerButtonRow", "./icons/Layers2.png", "30px");
			google.maps.event.addDomListener(button, 'click', function() {
				hideShowPanelsAndMapButtons("layerPanel");
			});
			buttonsDiv.index = 1;
			map.controls[controlPosition].push(buttonsDiv);
			buttonsDiv.style.display = show;
		}

		function AddFAQButtons(map, controlPosition) {
			var buttonsDiv = document.createElement('div');
			var button;
			button = SingleButtonRow(buttonsDiv, "faqButtonRow", "./icons/FAQ3.png", "30px");

			google.maps.event.addDomListener(button, 'click', function() {
				hideShowPanelsAndMapButtons("faqPanel");
			});
			buttonsDiv.index = 1;
			map.controls[controlPosition].push(buttonsDiv);
			buttonsDiv.style.display = "block";
			buttonsDiv.style.borderStyle = "none";
		}

		function AddFullScreenButtons(map, controlPosition) {
			var buttonsDiv = document.createElement('div');
			var button;
			button = SingleButtonRow(buttonsDiv, "fullScreenButtonRow", "./icons/fullScreen.png", "30px");
			google.maps.event.addDomListener(button, 'click', function() {
				var elementToSendFullscreen = map.getDiv().firstChild;
				if (isFullscreen(elementToSendFullscreen)) {
					exitFullScreen();
					button.style.backgroundImage = 'url("./icons/fullScreen.png")';
				} else {
					requestFullscreen(elementToSendFullscreen);
					button.style.backgroundImage = 'url("./icons/fullScreenOff.png")';
				}
			});
			buttonsDiv.index = 1;
			map.controls[controlPosition].push(buttonsDiv);
		}

		//Using our custom control to zoom in/out of the google map, with code from https://jsfiddle.net/maunovaha/jptLfhc8/
		function ZoomControl(controlDiv, map) {
			// Creating divs & styles for custom zoom control
			controlDiv.style.padding = '5px';

			// Set CSS for the control wrapper
			var controlWrapper = document.createElement('div');
			controlWrapper.style.backgroundColor = 'white';
			controlWrapper.style.borderStyle = 'solid';
			controlWrapper.style.borderColor = 'gray';
			controlWrapper.style.borderWidth = '1px';
			controlWrapper.style.cursor = 'pointer';
			controlWrapper.style.textAlign = 'center';
			controlWrapper.style.width = '61px';
			controlWrapper.style.height = '30px';
			controlDiv.appendChild(controlWrapper);

			// Set CSS for the zoomIn
			var zoomInButton = document.createElement('div');
			zoomInButton.style.width = '31px';
			zoomInButton.style.height = '30px';
			zoomInButton.style.float = 'left';
			/* Change this to be the .png image you want to use */
			zoomInButton.style.backgroundImage = 'url("./icons/zoomIn.png")';
			controlWrapper.appendChild(zoomInButton);

			// Set CSS for the zoomOut
			var zoomOutButton = document.createElement('div');
			zoomOutButton.style.width = '30px';
			zoomOutButton.style.height = '30px';
			zoomOutButton.style.float = 'left';
			/* Change this to be the .png image you want to use */
			zoomOutButton.style.backgroundImage = 'url("./icons/zoomOut.png")';
			controlWrapper.appendChild(zoomOutButton);

			// Setup the click event listener - zoomIn
			google.maps.event.addDomListener(zoomInButton, 'click', function() {
				map.setZoom(map.getZoom() + 1);
			});

			// Setup the click event listener - zoomOut
			google.maps.event.addDomListener(zoomOutButton, 'click', function() {
				map.setZoom(map.getZoom() - 1);
			});
		}

		//Using our custom control to make the map fullscreen, using code from 
		//https://developers.google.com/maps/documentation/javascript/examples/control-replacement
		function isFullscreen(element) {
			return (document.fullscreenElement ||
				document.webkitFullscreenElement ||
				document.mozFullScreenElement ||
				document.msFullscreenElement) == element;
		}

		function requestFullscreen(element) {
			if (element.requestFullscreen) {
				element.requestFullscreen();
			} else if (element.webkitRequestFullScreen) {
				element.webkitRequestFullScreen();
			} else if (element.mozRequestFullScreen) {
				element.mozRequestFullScreen();
			} else if (element.msRequestFullScreen) {
				element.msRequestFullScreen();
			}
		}

		function exitFullScreen() {
			if (document.exitFullscreen) {
				document.exitFullscreen();
			} else if (document.mozCancelFullScreen) {
				document.mozCancelFullScreen();
			} else if (document.webkitCancelFullScreen) {
				document.webkitCancelFullScreen();
			} else if (document.msExitFullscreen) {
				document.msExitFullscreen();
			}
		}

		function changeMonitorTypes(changeType) {
			
			updateMapAndLegend(currentMapPollCodeName);
			if (selectedSiteType === changeType) {
				deselectSite();
			} else {
				reselectSite();
			}
			if ((changeType == featureType.AQE) || (changeType == featureType.LAQN)) {
				showOther= document.getElementById('otheroption').checked;
			}
			if (changeType == featureType.FIA) {
				showSchool= document.getElementById('schooloption').checked;
			}
		}

		var lastCarVisibility = 0; //  0=>false; 1=true;
		function setDefaultCarStyle(theVisibility) {
			if ((theVisibility === true) && (lastCarVisibility === 1)) {
				return;
			}
			if ((theVisibility === false) && (lastCarVisibility === 0)) {
				return;
			}
			if ((carLayer !== null)) {
				startCarSpinner();
				var carCount = 0;
				carLayer.setStyle(function(feature) {
					carCount++;
					
					if (carCount === COUNT_OF_GOOGLE_ROADS) { // HACK hard-coded maximum number of roads
						stopCarSpinner();	
					}
					/* TODO Get the properties based on the selected pollutant */
					var POLL_MEDIAN;
					var POLL_COUNT;
					var color;
					var isVisible = theVisibility;

					if (currentMapPollCodeName === "NO2") {
						POLL_MEDIAN = feature.getProperty('no2_med');
						POLL_COUNT = feature.getProperty('no2_count');
						color = colourFromNO2Value(POLL_MEDIAN);
					} else {
						POLL_MEDIAN = feature.getProperty('pm_2_5_med');
						POLL_COUNT = feature.getProperty('pm2_5_count');
						color = colourFromPM25Value(POLL_MEDIAN);
					}
					//All roads (over 10 visits) will have the same width
					//There may be roads with less than 10 for the selected pollutant (roads under 10 for all pollutants will not be in the dataset, but the counts for different pollutants can differ 

					var weight;
					if (map.getZoom() >= 15) {
						weight = 4;
					} else {
						weight = 1;
					}
					var opacity;
					if (POLL_COUNT < 10) {
						opacity = 0;
						weight = 0;
						isVisible = false;
					} else {
						opacity = 1;
					}
					return {
						strokeColor: color,
						strokeWeight: weight,
						strokeOpacity: opacity,
						visible: isVisible
					};
				});
				if (theVisibility === true) {
					lastCarVisibility = 1;
				}
				if (theVisibility === false) {
					lastCarVisibility = 0;
				}
			}
		}

		function enableDisableRegNetworks(enableOption) {
			if (enableOption) {
				document.getElementById("otheroption").disabled = false;
				document.getElementById("otheroption").checked = showOther;
				document.getElementById("otheroptiontext").style.color = "#676767";
				document.getElementById("otheroptionimg").style.stroke = "#676767";
				document.getElementById("otheroptionlabel").style.borderColor = "#f00379";
				document.getElementById("otheroptionlabel").style.backgroundColor = "";
			} else {
				showOther = document.getElementById("otheroption").checked;
				document.getElementById("otheroption").checked = false;
				document.getElementById("otheroptiontext").style.color = "#dddddd";
				document.getElementById("otheroptionimg").style.stroke = "#dddddd";
				document.getElementById("otheroptionlabel").style.borderColor = "#dddddd";
				document.getElementById("otheroptionlabel").style.backgroundColor = "#dddddd";
				document.getElementById("otheroption").disabled = true;
			}
		}

		function enableDisableFIA(enableOption) {
			if (enableOption) {
				document.getElementById("schooloption").disabled = false;
				document.getElementById("schooloption").checked = showSchool;
				document.getElementById("schooloptiontext").style.color = "#676767";
				document.getElementById("schooloptionimg").style.stroke = "#676767";
				document.getElementById("schooloptionlabel").style.borderColor = "#f00379";
				document.getElementById("schooloptionlabel").style.backgroundColor = "";
			} else {
				showSchool = document.getElementById("schooloption").checked;
				document.getElementById("schooloption").checked = false;
				document.getElementById("schooloptiontext").style.color = "#dddddd";
				document.getElementById("schooloptionimg").style.stroke = "#dddddd";
				document.getElementById("schooloptionlabel").style.borderColor = "#dddddd";
				document.getElementById("schooloptionlabel").style.backgroundColor = "#dddddd";
				document.getElementById("schooloption").disabled = true;
			}
		}


		function enableDisableLHSControls() {
			//Called if current/average, monitor type or pollutant changed
			var showConcentrationSection = true;

			var enableRegulatoryNetworks = false;
			var enableSchoolStreets = false;
			var enableOnRoad = false;

			var enableNOx = false;
			var enablePM25_NO2 = true;

			var noDataLabel = "No data";
			if (dataMode === "average") {
				enableOnRoad = true;
				$("#nowhourtitle2").html("Average air quality");
				enableSchoolStreets = true;
				
			} else if (dataMode === "source") {
				enableNOx = true;
				enablePM25_NO2 = false;
				showConcentrationSection = false;
				$("#nowhourtitle2").html("Sources");
				enableRegulatoryNetworks = true;
			} else {
				enableRegulatoryNetworks = true;
				enableSchoolStreets = true;
				$("#nowhourtitle2").html("Current air quality");
				noDataLabel = "No current data";
			}
			enableDisableRegNetworks(enableRegulatoryNetworks);
			enableDisableFIA(enableSchoolStreets);
			document.getElementById("noDataLocations").innerHTML = noDataLabel;
			var thePollutantCode = $("input[name='pollutantRadios']:checked").val();

			if ((thePollutantCode === "NOx") && !enableNOx) {
				//Default to NO2 ???
				thePollutantCode = "NO2";
				$("#NO2").prop("checked", true);
				currentMapPollCodeName = "NO2";
			}

			if ((thePollutantCode !== "NOx") && !enablePM25_NO2) {
				//Default to NOx 
				//Set the radio button 
				thePollutantCode = "NOx";
				$("#NOx").prop("checked", true);
				currentMapPollCodeName = "NOx";
			}

			if (thePollutantCode !== "NO2") {
				enableOnRoad = false;
			}

			document.getElementById('pastlocations').style.display = "";

			document.getElementById("caroption").checked = enableOnRoad;
			if (enableOnRoad) {
				enableRoads(false);
			} else {
				disableRoads(true);
			}
			
			document.getElementById('NO2table').style.display = (((thePollutantCode == "NO2") || (thePollutantCode == "NOx")) ? "block" : "none");
			document.getElementById('PM25table').style.display = ((thePollutantCode == "PM2_5") ? "block" : "none");
			document.getElementById('ConcentrationSection').style.display = ((showConcentrationSection) ? "block" : "none");
			sectionSizer();
			document.getElementById('NOx').disabled = !enableNOx;
			
			document.getElementById('NO2').disabled = !enablePM25_NO2;
			document.getElementById('PM2_5').disabled = !enablePM25_NO2;
			document.getElementById('NOxLabel').style.color = ((enableNOx) ? "#676767":"#dadada");
			document.getElementById('PM2_5Label').style.color = ((enablePM25_NO2) ? "#676767":"#dadada");
			document.getElementById('NO2Label').style.color = ((enablePM25_NO2) ? "#676767":"#dadada");
		}

		function enableDisableRHSControls(typeMonitor, historicalOnly, showairTEXT) {
			var isAverage;
			isAverage = (dataMode === "average");
			var isBLPod;
			isBLPod = (typeMonitor === "BL");
			var isSchoolPod;
			isSchoolPod = (typeMonitor === "School");
			var isOtherPod;
			isOtherPod = (typeMonitor === "Other");
			var isGoogle;
			isGoogle = (typeMonitor === "road");
			var isSource;
			isSource = (dataMode === "source");

			//Breathe London pods only
			document.getElementById('monitorBorough').style.display = (!isGoogle ? "block" : "none");
			document.getElementById('monitorType').style.display = (!isGoogle ? "block" : "none");
			document.getElementById('graphRHS').style.display = (((isBLPod && !historicalOnly) || (isSource)) ? "block" : "none");
			document.getElementById('airTEXT').style.display = ((!historicalOnly && (dataMode === "current") && showairTEXT) ? "block" : "none");
			document.getElementById('graphButton').style.display = ((isBLPod && !historicalOnly && !isSource) ? "block" : "none");

			//Breathe London pods only (Past locations only) - dealt with elsewhere
			//MonitorTime is shown in all cases except Google Car and Current Historical
			document.getElementById('monitorTime').style.display = ((isSchoolPod || isGoogle || ((dataMode === "current") && historicalOnly)) ? "none" : "block");
			document.getElementById('graphHistoryButton').style.display = ((isBLPod && historicalOnly) ? "block" : "none");
			document.getElementById('monitorHistorical').style.display = ((isBLPod && historicalOnly && !isSource) ? "block" : "none");

			//Breathe London pods only (Average only)
			document.getElementById('monitorTime2').style.display = (((isBLPod && (dataMode !== "current")) || isSource) ? "block" : "none");
			document.getElementById('subcategories').style.display = ((dataMode === "source") ? "block" : "none");
			document.getElementById('overView').style.display = ((dataMode === "source") ? "none" : "block");

			//Google car only
			document.getElementById('Passes').style.display = ((isGoogle) ? "" : "none");

			if (isBLPod) {
				$(".c40only").show();
			} else {
				$(".c40only").hide();
			}

			if (isOtherPod || isSchoolPod) {
				$(".laqnonly").show();
			} else {
				$(".laqnonly").hide();
			}
		}

		function createPopupClass() {
			/**
			 * A customized popup on the map.
			 * @param {!google.maps.LatLng} position
			 * @param {!Element} content The bubble div.
			 * @constructor
			 * @extends {google.maps.OverlayView}
			 */
			function Popup(position, label, colour, site) {
				this.position = position;

				var popupDiv = document.createElement("div");
				popupDiv.setAttribute("id", "content");
				var labelElement = document.createElement("Label");
				labelElement.innerHTML = label;
				popupDiv.appendChild(labelElement);
				popupDiv.classList.add('popup-bubble');
				popupDiv.style.backgroundColor = colour;

				if (colour == 'white') {
					popupDiv.style.color = BreatheLondonPinkColour;
				}

				// This zero-height div is positioned at the bottom of the bubble.
				var bubbleAnchor = document.createElement('div');
				bubbleAnchor.classList.add('popup-bubble-anchor');
				bubbleAnchor.appendChild(popupDiv);

				if (site !== "") {
					popupDiv.addEventListener('click', function(event) {
						if (site.feature.properties.Network === "LAQN") {
							selectSite(site, featureType.LAQN, false);
						} else if (site.feature.properties.Network === "AQE") {
							selectSite(site, featureType.AQE, false);
						} else if (site.feature.properties.Network === "FIA") {
							selectSite(site, featureType.FIA, false);
						} else {
							selectSite(site, featureType.AQMESH, false);
						}
					});
					bubbleAnchor.addEventListener('click', function(event) {
						if (site.feature.properties.Network === "LAQN") {
							selectSite(site, featureType.LAQN, false);
						} else if (site.feature.properties.Network === "AQE") {
							selectSite(site, featureType.AQE, false);
						} else if (site.feature.properties.Network === "FIA") {
							selectSite(site, featureType.FIA, false);
						} else {
							selectSite(site, featureType.AQMESH, false);
						}
					});
				}


				// This zero-height div is positioned at the bottom of the tip.
				this.containerDiv = document.createElement('div');
				this.containerDiv.classList.add('popup-container');
				this.containerDiv.appendChild(bubbleAnchor);

				// Optionally stop clicks, etc., from bubbling up to the map.
				google.maps.OverlayView.preventMapHitsAndGesturesFrom(this.containerDiv);
			}
			// ES5 magic to extend google.maps.OverlayView.
			Popup.prototype = Object.create(google.maps.OverlayView.prototype);

			/** Called when the popup is added to the map. */
			Popup.prototype.onAdd = function() {
				this.getPanes().floatPane.appendChild(this.containerDiv);
			};

			/** Called when the popup is removed from the map. */
			Popup.prototype.onRemove = function() {
				if (this.containerDiv.parentElement) {
					this.containerDiv.parentElement.removeChild(this.containerDiv);

				}
			};

			/** Called each frame when the popup needs to draw itself. */
			Popup.prototype.draw = function() {
				var divPosition = this.getProjection().fromLatLngToDivPixel(this.position);

				// Hide the popup when it is far out of view.
				var display =
					Math.abs(divPosition.x) < 4000 && Math.abs(divPosition.y) < 4000 ?
					'block' :
					'none';

				if (display === 'block') {
					this.containerDiv.style.left = divPosition.x + 'px';
					this.containerDiv.style.top = divPosition.y + 'px';
				}
				if (this.containerDiv.style.display !== display) {
					this.containerDiv.style.display = display;
				}
			};

			return Popup;
		}

		function autocomplete(inp) {
			/* the autocomplete function takes two arguments,
			the text field element and an array of possible autocompleted values:*/
			var currentFocus;


			/* execute a function when someone writes in the text field:*/
			inp.addEventListener("input", function(e) {
				var a, b, i, val = this.value;
				/*close any already open lists of autocompleted values*/
				closeAllLists();
				if (!val) {
					return false;
				}
				currentFocus = -1;
				/*create a DIV element that will contain the items (values):*/
				a = document.createElement("DIV");
				a.setAttribute("id", "autocomplete-list");
				a.setAttribute("class", "autocomplete-items");

				/*append the DIV element as a child of the autocomplete container:*/
				this.parentNode.appendChild(a);

				/* for each item in the array...*/
				for (i = 0; i < sites.length; i++) {
					if (document.getElementById('autocomplete-list').childElementCount < 5) {
						var includeInList = true;
						if ((typeof sites[i].feature.properties[currentMapPollCodeName] == 'undefined') && (currentMapPollCodeName !== "NOx")) {
							includeInList = false;
						} else if ((currentMapPollCodeName == "NOx") && (!sites[i].feature.properties.NOX)) {
							includeInList = false;
						} else if ((currentMapPollCodeName == "NOx") && (!sites[i].feature.properties.NOX.Sources)) {
							includeInList = false;
						} 

						if (((sites[i].feature.properties.Network === "C40" && document.getElementById("bloption").checked === true) || (sites[i].feature.properties.Network === "LAQN" && document.getElementById("otheroption").checked === true) || (sites[i].feature.properties.Network === "AQE" && document.getElementById("otheroption").checked === true) || (sites[i].feature.properties.Network === "FIA" && document.getElementById("schooloption").checked === true)) && includeInList) {
							/*check if the item starts with the same letters as the text field value:*/
							if (sites[i].feature.properties.Name.substr(0, val.length).toUpperCase() == val.toUpperCase()) {
								/*create a DIV element for each matching element:*/
								b = document.createElement("DIV");
								b.setAttribute("class", "searchOptionMonitor");
								//b.setAttribute("style","margin: 0px 0px 2px 5px; font-size: 11pt;border-top-style:dotted;border-top-width:1px;");
								/* make the matching letters bold:*/
								b.innerHTML = "<strong>" + sites[i].feature.properties.Name.substr(0, val.length) + "</strong>";
								b.innerHTML += sites[i].feature.properties.Name.substr(val.length);
								/*insert a input field that will hold the current array item's value:*/
								b.innerHTML += "<input type='hidden' value='" + sites[i].feature.properties.Name + "'>";
								/*execute a function when someone clicks on the item value (DIV element):*/
								b.addEventListener("click", function(e) {
									/*insert the value for the autocomplete text field:*/
									inp.value = this.getElementsByTagName("input")[0].value;
									/*close the list of autocompleted values,
									or any other open lists of autocompleted values:*/
									closeAllLists();
									document.getElementById('searchControls').style.display = 'none';

									searchSite();
									//document.getElementById("searchInputTextBox").value="";
								});
								a.appendChild(b);
							}
							if (sites[i].feature.properties.Network === "C40") {
								if (sites[i].feature.properties.UniqueID.substr(0, val.length) == val) {
									/*create a DIV element for each matching element:*/
									b = document.createElement("DIV");
									//b.setAttribute("style","margin: 0px 0px 2px 5px; font-size: 11pt;border-top-style:dotted;border-top-width:1px;");
									b.setAttribute("class", "searchOptionMonitor");
									/* make the matching letters bold:*/
									b.innerHTML = "<strong>" + sites[i].feature.properties.UniqueID.substr(0, val.length) + "</strong>";
									b.innerHTML += sites[i].feature.properties.UniqueID.substr(val.length) + "  (" + sites[i].feature.properties.Name + ")";
									/*insert a input field that will hold the current array item's value:*/
									b.innerHTML += "<input type='hidden' value='" + sites[i].feature.properties.Name + "'>";
									/*execute a function when someone clicks on the item value (DIV element):*/
									b.addEventListener("click", function(e) {
										/*insert the value for the autocomplete text field:*/
										inp.value = this.getElementsByTagName("input")[0].value;
										/*close the list of autocompleted values,
										or any other open lists of autocompleted values:*/
										closeAllLists();
										document.getElementById('searchControls').style.display = 'none';
										searchSite();
										document.getElementById("searchInputTextBox").value = "";


									});
									a.appendChild(b);
								}
							}
						}
					}
				}
			});

			/*execute a function presses a key on the keyboard:*/
			inp.addEventListener("keydown", function(e) {
				var x = document.getElementById(this.id + "autocomplete-list");
				if (x) x = x.getElementsByTagName("div");
				if (e.keyCode == 40) {
					/*If the arrow DOWN key is pressed,
					increase the currentFocus variable:*/
					currentFocus++;
					/*and and make the current item more visible:*/
					addActive(x);
				} else if (e.keyCode == 38) { //up
					/*If the arrow UP key is pressed,
					decrease the currentFocus variable:*/
					currentFocus--;
					/*and and make the current item more visible:*/
					addActive(x);
				} else if (e.keyCode == 13) {
					/*If the ENTER key is pressed, prevent the form from being submitted,*/
					e.preventDefault();
					if (currentFocus > -1) {
						/*and simulate a click on the "active" item:*/
						if (x) x[currentFocus].click();
					}
				}
			});

			function addActive(x) {
				/*a function to classify an item as "active":*/
				if (!x) return false;
				/*start by removing the "active" class on all items:*/
				removeActive(x);
				if (currentFocus >= x.length) currentFocus = 0;
				if (currentFocus < 0) currentFocus = (x.length - 1);
				/*add class "autocomplete-active":*/
				x[currentFocus].classList.add("autocomplete-active");
			}

			function removeActive(x) {
				/*a function to remove the "active" class from all autocomplete items:*/
				for (var i = 0; i < x.length; i++) {
					x[i].classList.remove("autocomplete-active");
				}
			}

			function closeAllLists(elmnt) {
				/*close all autocomplete lists in the document,
				except the one passed as an argument:*/
				var x = document.getElementsByClassName("autocomplete-items");
				for (var i = 0; i < x.length; i++) {
					if (elmnt !== x[i] && elmnt !== inp) {
						x[i].parentNode.removeChild(x[i]);
					}
				}

			}

			/*execute a function when someone clicks in the document:*/
			document.addEventListener("click", function(e) {
				closeAllLists(e.target);
			});
		}

		function closeFAQ() {

			var phoneShow;
			if (useSmallScreen()) {
				phoneShow = "block";
			} else {
				phoneShow = "none";
			}
			map.controls[google.maps.ControlPosition.RIGHT_TOP].clear();
			ShowSearchButton(map, google.maps.ControlPosition.RIGHT_TOP);
			AddLayerButtons(map, google.maps.ControlPosition.RIGHT_TOP, phoneShow);
			ShowCurrentLocationButtons(map, google.maps.ControlPosition.RIGHT_TOP);
			AddFAQButtons(map, google.maps.ControlPosition.RIGHT_TOP);
			hideShowPanelsAndMapButtons("");
		}

		function clearLocationWarnings() {
			document.getElementById("currentLocationWarning").innerHTML = "";
			document.getElementById("currentLocationWarning").style.display = 'none';
			document.getElementById("searchLocationWarning").innerHTML = "";
			document.getElementById("searchLocationWarning").style.display = 'none';
		}

		function ShowFAQFromLink() {
			deselectSite();
			hideShowPanelsAndMapButtons('faqPanel');
		}

		function getCategoryDataForSelectedFeature(categoryCodeName) {
			//For non IE browsers we can use find and arrow functions to find the category
			// e.g. return selectedFeature.feature.properties.NOX.Sources.Categories.find(x => x.CodeName === categoryCodeName);
			if (!!selectedFeature.feature.properties.NOX) {
				if (!!selectedFeature.feature.properties.NOX.Sources) {

					var x = selectedFeature.feature.properties.NOX.Sources.Categories;
					for (var i = 0; i < x.length; i++) {

						if (x[i].CodeName == categoryCodeName) {

							return x[i];
						}
					}
				}
			}
		}


		function getCategoryPercentage(categoryCodeName) {
			var cat = getCategoryDataForSelectedFeature(categoryCodeName);
			if (!cat) {
				console.log("No Category " + categoryCodeName);
				return 0;
			}

			return cat.Percentage;
		}

		function setForecast(forecasts, addDaysToToday, control) {
			var alertLevel = "n/a";
			if (!forecasts) {


			} else {
				var forecastDate = new Date();
				forecastDate.setDate(forecastDate.getDate() + addDaysToToday);
				var datestring = forecastDate.getFullYear() + "-" + ("0" + (forecastDate.getMonth() + 1)).slice(-2) + "-" + ("0" + forecastDate.getDate()).slice(-2);

				for (var i = 0; i < forecasts.length; i++) {
					if (forecasts[i].Date == datestring) {
						alertLevel = forecasts[i].AlertLevel;
					}
				}
			}
			switch (alertLevel) {
				case "LOW":
					alertLevel = "no alert";
					$(control).css({
						"color": "#888888",
						"background-color": "#dadada",
						'font-style': 'italic',
						'font-weight': 'normal'
					});
					break;
				case "":
					alertLevel = "n/a";
					$(control).css({
						"color": "#888888",
						"background-color": "#dadada",
						'font-style': 'italic',
						'font-weight': 'normal'
					});
					break;
				default:
					$(control).css({
						"color": "#000000",
						"background-color": "#adadad",
						'font-style': 'normal',
						'font-weight': 'bold'
					});
			}

			$(control).text(alertLevel);
		}


		function fillSourceTable() {
			var categoryMeta = categoryLookup[currentBar];
			$("#sourcetb tbody tr").remove();
			$('#categoryIMG').attr("src", categoryMeta.imgSelected); 
			var cat = getCategoryDataForSelectedFeature(categoryMeta.codeName);
			if (!cat) {
				console.log("No Category " + categoryMeta.codeName);
			} else {
				var i;
				var othercars ="";
				for (i = 0; i < cat.SubCategories.length; i++) {
					var displayName = subcategoryLookup[cat.SubCategories[i].CodeName];
					if (!displayName) {
						displayName = cat.SubCategories[i].CodeName;
					}
					var percentText="";
					if (cat.SubCategories[i].Percentage >= 0.5) {
						percentText=cat.SubCategories[i].Percentage.toFixed(0) + "%";
					} else if (cat.SubCategories[i].Percentage >= 0.01) {
						percentText="<1%";
					}
					if (percentText !== "") {
						//Hard coding diesel cars to be before other cars
						if (cat.SubCategories[i].CodeName == "TaxisOtherCarsMotorcycles") {
							othercars = '<tr style="height:32px;"><td>' + displayName + '</td><td style="text-align: right;">' + percentText + '</td></tr>';
						} else {
							$('#sourcetb').append('<tr style="height:32px;"><td>' + displayName + '</td><td style="text-align: right;">' + percentText + '</td></tr>');
							if (cat.SubCategories[i].CodeName == "DieselCars") {
								$('#sourcetb').append(othercars);
							}
						}
					}
				}
			}
			recalculateScrollbar();
		}

		function startCarSpinner() {
			if (carSpinner === null) {
				console.log("Starting Spinner for Roads");
				carSpinner = new Spinner({
					scale: 2
				});
				var spinnerContainer = $("#map");
				spinnerContainer.after(carSpinner.spin().el);
			}
		}
		
		function stopCarSpinner() {
			
			if (carSpinner !== null) {
				console.log("Stopping Spinner for Roads");
				carSpinner.stop();
				carSpinner = null;
			}
		}
		
		function rad(x) {
			return x * Math.PI / 180;
		}
		//Uses the Haversine formula to calculate the nearest pod
		function find_closest_pod(event) {
			var lat = event.lat;
			var lng = event.lng;
			var R = 6371; // radius of earth in km
			var distances = [];
			var closest = -1;

			var includeOther = document.getElementById("otheroption").checked;
			var includeSchool = document.getElementById("schooloption").checked;
			var includeBL = document.getElementById("bloption").checked;

			//Loop through the pods
			for (i = 0; i < sites.length; i++) {
				//Only check pods that are enabled, and don't check historical pods
				if ((includeOther && sites[i].feature.properties.Network === "LAQN") || (includeSchool && sites[i].feature.properties.Network === "FIA") || (includeOther && sites[i].feature.properties.Network === "AQE") || ((includeBL && sites[i].feature.properties.Network === "C40") && (sites[i].feature.properties.LocationEndDate === undefined))) {
					//Don't include sites that don't measure this pollutant
					if  (((currentMapPollCodeName == "NOx") && (!!sites[i].feature.properties.NOX)) ||
					  ((currentMapPollCodeName == "NO2") && (!!sites[i].feature.properties.NO2)) ||
					  ((currentMapPollCodeName == "PM2_5") && (!!sites[i].feature.properties.PM2_5)))
					{
						if (((currentMapPollCodeName == "NOx") && (!!sites[i].feature.properties.NOX.Sources)) || (currentMapPollCodeName != "NOx")) {
							var mlat = sites[i].feature.geometry.coordinates[1];
							var mlng = sites[i].feature.geometry.coordinates[0];
							var dLat = rad(mlat - lat);
							var dLong = rad(mlng - lng);
							var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
								Math.cos(rad(lat)) * Math.cos(rad(lat)) * Math.sin(dLong / 2) * Math.sin(dLong / 2);
							var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
							var d = R * c;
							distances[i] = d;
							if (closest == -1 || d < distances[closest]) {
								closest = i;
							}
						} 
					}
				}
			}

			var bounds = new google.maps.LatLngBounds();

			if (closest !== -1) {
				//If a nearest pod has been found
				if (useSmallScreen() === false) {
					//Select the nearest pod (but only for large screen)
					if (sites[closest].feature.properties.Network === "LAQN") {
						selectSite(sites[closest], featureType.LAQN, true);
					} else if (sites[closest].feature.properties.Network === "AQE") {
						selectSite(sites[closest], featureType.AQE, true);
					} else if (sites[closest].feature.properties.Network === "FIA") {
						selectSite(sites[closest], featureType.FIA, true);
					} else {
						selectSite(sites[closest], featureType.AQMESH, true);
					}
				}
				//Extend the map view to centre the current location and ensure the pod is on the map
				var myLatlng = new google.maps.LatLng(sites[closest].feature.geometry.coordinates[1], sites[closest].feature.geometry.coordinates[0]);

				var newLat = lat + (lat - sites[closest].feature.geometry.coordinates[1]);
				var newLon = lng + (lng - sites[closest].feature.geometry.coordinates[0]);

				var myLatlng2 = new google.maps.LatLng(newLat, newLon);
				bounds.extend(myLatlng);
				bounds.extend(myLatlng2);
			} else {
				//No pod found, just zoom on the current location
				bounds.extend(event);
			}
			map.fitBounds(bounds);

			var tempZoom = map.getZoom();

			if (tempZoom > 18) {
				//Zoom level 18 is as far zoomed in we would want
				tempZoom = 18;
			} else {
				if (useSmallScreen() === false) {
					//Google will have chosen a zoom level to show everything, but we don't want the pod hidden by the panels on the large screen, so we zoom out an extra level
					tempZoom = tempZoom - 1;
				}
			}

			map.setZoom(tempZoom);
			if (useSmallScreen() === true) {
				deselectSite();
				var labelText = sites[closest].feature.properties.Name;
				var latLng = new google.maps.LatLng(sites[closest].feature.geometry.coordinates[1], sites[closest].feature.geometry.coordinates[0]);
				var labelcolour;
				if (sites[closest].feature.properties.Network === "LAQN") {
					labelcolour = NoLevelBorderColour;
				} else if (sites[closest].feature.properties.Network === "AQE") {
					labelcolour = NoLevelBorderColour;
				} else if (sites[closest].feature.properties.Network === "FIA") {
					labelcolour = NoLevelBorderColour;
				} else {
					labelcolour = BreatheLondonPinkColour;
				}
				nearestSite = new Popup(latLng, labelText, labelcolour, sites[closest]);

				nearestSite.setMap(map);

			}
		}

		/*initiate the autocomplete function on the "searchInputTextBox" element, and pass along the array as possible autocomplete values:*/
		autocomplete(document.getElementById("searchInputTextBox"));
    
    </script> 
    <!-- To reimplement Google place searches, add &libraries=places to the api url -->    
     
	<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=GOOGLEMAPSAPIKEY&callback=loadPage&libraries=places"></script> 
		
	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script> 
    <!--  Added to make IE11 use the responsive picture element  -->
    <script src="./js/picturefill.min.js"></script>	
		
    <script src="./js/jquery-ui.min.js"></script>
    <!-- Plotly.js Basic, fixed version 1.44.1, minified -->
    <script async defer src="https://cdn.plot.ly/plotly-basic-1.44.1.min.js"></script>    


	
    <script src="./js/spin.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/simplebar@4.2.3/dist/simplebar.css" />
    <script src="https://unpkg.com/simplebar@4.2.3/dist/simplebar.min.js"></script> 
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=Intl.~locale.en"></script>
    <script src="https://momentjs.com/downloads/moment.js"></script>
    <script src="https://momentjs.com/downloads/moment-timezone-with-data-1970-2030.min.js"></script>

  </body>
</html>
